<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng Kanban Task (C·∫£i Ti·∫øn C·ªôt)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.6;
            overscroll-behavior: none; /* Prevent pull-to-refresh issues with swipe */
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            margin-bottom: 20px;
        }

        /* --- App Header --- */
        #app-main-header {
            text-align: center;
            margin-bottom: 20px;
        }
        #app-main-header h1 {
            color: #1890ff;
            font-weight: 600;
            font-size: 1.75rem; /* Adjusted size */
            margin: 0;
        }

        /* --- Actions Bar (Toggle Filter & View Archive) --- */
        .actions-bar-container {
            background-color: #fff;
            padding: 12px 20px; /* Slightly reduced padding */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            gap: 10px; /* Space between buttons */
        }

        .actions-bar-container button { /* Common style for buttons in this bar */
            padding: 10px 18px; /* Adjusted padding */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem; /* Adjusted font size */
            font-weight: 500;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
        }
        .actions-bar-container button .icon {
            margin-right: 8px;
        }

        #toggle-filter-bar-btn {
            background-color: #52c41a; /* Green */
        }
        #toggle-filter-bar-btn:hover {
            background-color: #389e0d;
        }
        #view-archived-btn {
            background-color: #722ed1; /* Purple */
        }
        #view-archived-btn:hover {
            background-color: #531dab;
        }


        /* Filter Bar Styling (collapsible) */
        .filter-bar {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            align-items: center;
            overflow: hidden;
            max-height: 0; /* Collapsed by default */
            opacity: 0;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, padding-top 0.5s ease-in-out, padding-bottom 0.5s ease-in-out, margin-bottom 0.5s ease-in-out;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0; /* No margin when collapsed */
        }
        .filter-bar.filter-bar-visible {
            max-height: 1000px; /* Large enough to accommodate content */
            opacity: 1;
            padding-top: 20px; /* Restore padding */
            padding-bottom: 20px; /* Restore padding */
            margin-bottom: 30px; /* Restore margin */
        }

        .filter-bar .form-group { display: flex; flex-direction: column; }
        .filter-bar label { font-size: 0.85rem; color: #595959; margin-bottom: 5px; }
        .filter-bar input[type="text"],
        .filter-bar select {
            padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px;
            font-size: 0.95rem; width: 100%; box-sizing: border-box;
        }
        .filter-bar input[type="text"]:focus,
        .filter-bar select:focus {
            border-color: #1890ff; box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2); outline: none;
        }
        .filter-bar .actions {
            grid-column: 1 / -1; display: flex; gap: 10px; justify-content: flex-end;
        }
         @media (min-width: 992px) {
            .filter-bar .actions { grid-column: auto; grid-row: 1; align-self: end; }
        }
        .filter-bar button { /* Buttons inside filter bar */
            padding: 10px 15px; background-color: #1890ff; color: white;
            border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem;
            font-weight: 500; transition: background-color 0.3s ease;
        }
        .filter-bar button.clear-filter-btn { background-color: #ff4d4f; }
        .filter-bar button.clear-filter-btn:hover { background-color: #f5222d; }
        .filter-bar button:hover { background-color: #40a9ff; }


        /* FAB for Add Task */
        .fab-add-task {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 28px;
            line-height: 60px; /* Center icon vertically */
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 999;
        }
        .fab-add-task:hover {
            background-color: #40a9ff;
            transform: scale(1.1);
        }

        /* --- Kanban Mobile Tabs --- */
        #kanban-mobile-tabs {
            display: none; /* Hidden by default, shown on mobile */
            background-color: #fff;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .mobile-tab-button {
            flex-grow: 1; text-align: center; padding: 12px 8px;
            font-size: 0.875rem; font-weight: 500; cursor: pointer;
            border-bottom: 3px solid transparent; color: #595959;
            transition: color 0.2s ease, border-color 0.2s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .mobile-tab-button .icon { margin-right: 6px; width: 16px; height: 16px; }
        .mobile-tab-button.active-tab {
            /* Default active color, will be overridden by specific status colors */
            border-bottom-color: #1890ff; color: #1890ff;
        }
        .mobile-tab-button#tab-todo.active-tab { border-bottom-color: #eb2f96; color: #eb2f96; }
        .mobile-tab-button#tab-inprogress.active-tab { border-bottom-color: #faad14; color: #faad14; }
        .mobile-tab-button#tab-done.active-tab { border-bottom-color: #52c41a; color: #52c41a; }


        /* Kanban Board Styling */
        .kanban-board {
            display: flex;
            gap: 15px; /* Reduced gap between columns */
            justify-content: space-around;
            flex-wrap: wrap;
        }
        .kanban-column {
            border-radius: 8px; padding: 20px;
            width: 350px; min-height: 450px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex; flex-direction: column; transition: background-color 0.3s ease, border 0.3s ease;
        }
        .kanban-column#todo { background-color: #fff0f6; /* Light Pink */ }
        .kanban-column#inprogress { background-color: #fffbe6; /* Light Yellow */ }
        .kanban-column#done { background-color: #f6ffed; /* Light Green */ }

        .kanban-column .column-header { /* New container for icon, title, count */
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px; border-bottom: 2px solid #e8e8e8;
        }
        .kanban-column .column-header .title-group {
            display: flex; align-items: center;
            font-size: 1.3rem; font-weight: 600;
        }
        .kanban-column .column-header .column-icon {
            width: 20px; height: 20px; margin-right: 10px;
        }
        .kanban-column#todo .column-header .title-group { color: #eb2f96; } /* Pinkish for To Do title */
        .kanban-column#inprogress .column-header .title-group { color: #faad14; } /* Orange/Yellow for In Progress title */
        .kanban-column#done .column-header .title-group { color: #52c41a; } /* Green for Done title */

        .kanban-column h2 { /* Remove default h2 margins if used inside .column-header */
            margin: 0; font-size: inherit; font-weight: inherit; color: inherit;
            border-bottom: none; padding-bottom: 0;
        }
        .kanban-column .task-count-badge {
            font-size: 0.8rem; color: #fff; background-color: #8c8c8c; /* Default badge color */
            padding: 3px 8px; border-radius: 12px; font-weight: 500;
            min-width: 24px; text-align: center;
        }
        /* Specific badge colors to match column titles */
        .kanban-column#todo .task-count-badge { background-color: #eb2f96; }
        .kanban-column#inprogress .task-count-badge { background-color: #faad14; }
        .kanban-column#done .task-count-badge { background-color: #52c41a; }


        .tasks-container {
            background-color: #fff; /* White background for task cards area inside colored columns */
            border-radius: 6px; padding: 15px;
            min-height: 250px; flex-grow: 1; transition: background-color 0.2s ease;
            border: 1px dashed transparent;
        }
        .tasks-container.empty {
            display: flex; flex-direction: column; /* For icon above text */
            align-items: center; justify-content: center; text-align: center;
            color: #aaa; font-style: italic; min-height: 150px;
            background-color: rgba(255, 255, 255, 0.7); /* Slightly transparent white if column has color */
        }
        .tasks-container.empty .empty-icon {
            width: 40px; height: 40px; margin-bottom: 10px; opacity: 0.5;
        }


        /* Task Card Styling */
        .task-card {
            background-color: #ffffff; border: 1px solid #e8e8e8; border-left: 6px solid transparent;
            border-radius: 6px; padding: 15px 20px; margin-bottom: 12px; cursor: grab;
            box-shadow: 0 1px 4px rgba(0,0,0,0.07); transition: all 0.2s ease; position: relative;
        }
        .task-card.priority-high { border-left-color: #ff4d4f; }
        .task-card.priority-medium { border-left-color: #faad14; }
        .task-card.priority-low { border-left-color: #52c41a; }
        .task-card.due-overdue { background-color: #fff1f0; border-color: #ffccc7; }
        .task-card.due-soon { background-color: #fffbe6; border-color: #ffe58f; }
        .task-card.blocked {
            background-color: #fff1f0; border-left-color: #a8071a !important; border-color: #ffccc7;
        }
        .blocked-icon-wrapper { display: flex; align-items: center; margin-top: 8px; }
        .blocked-icon {
            color: #a8071a; font-weight: bold; cursor: help; font-size: 0.8em; margin-right: 6px;
            padding: 3px 6px; background-color: #ffccc7; border-radius: 4px; display: inline-flex; align-items: center;
        }
        .blocked-icon svg { width: 1em; height: 1em; margin-right: 4px; }
        .block-reason-text { font-size: 0.8em; color: #8c8c8c; font-style: italic; }
        .task-card-content { cursor: pointer; }
        .task-card:active { cursor: grabbing; box-shadow: 0 6px 12px rgba(0,0,0,0.12); transform: scale(1.03); }
        .task-card h4 { margin-top: 0; margin-bottom: 8px; font-size: 1.05rem; color: #0056b3; font-weight: 600; }
        .task-card p.task-description { font-size: 0.9rem; color: #595959; margin-bottom: 12px; white-space: pre-wrap; }
        .task-details { margin-top: 10px; font-size: 0.8rem; color: #8c8c8c; }
        .task-detail-item { margin-bottom: 4px; }
        .task-detail-item strong { color: #595959; }
        .task-detail-item .due-date.overdue { color: #ff4d4f; font-weight: bold; }
        .task-detail-item .due-date.soon { color: #faad14; font-weight: bold; }
        .task-tags { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 5px; }
        .task-tag {
            background-color: #e6f7ff; color: #1890ff; padding: 2px 8px;
            border-radius: 4px; font-size: 0.75em; font-weight: 500;
        }
        .task-card .task-meta {
            font-size: 0.8rem; color: #8c8c8c; margin-top: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .task-card .task-meta .task-priority-label {
            padding: 3px 8px; border-radius: 4px; font-weight: bold;
            text-transform: uppercase; font-size: 0.75em;
        }
        .task-card.priority-high .task-priority-label { background-color: #ff4d4f; color: white; }
        .task-card.priority-medium .task-priority-label { background-color: #faad14; color: #262626;}
        .task-card.priority-low .task-priority-label { background-color: #52c41a; color: white; }
        .task-card .task-actions { text-align: right; margin-top: 8px; }
        .task-card .delete-btn {
            background: none; border: none; color: #ff4d4f; cursor: pointer;
            font-size: 0.9rem; padding: 6px 8px; border-radius: 4px;
            transition: color 0.2s, background-color 0.2s;
        }
        .task-card .delete-btn:hover { color: #cf1322; background-color: #fff1f0; }

        /* Drag and Drop Styling */
        .dragging { opacity: 0.4; border: 2px dashed #1890ff; }
        .drag-over-column .tasks-container { background-color: #e6f7ff !important; border: 1px dashed #91d5ff; }
        .wip-limit-exceeded .tasks-container { border: 2px dashed #ff4d4f !important; background-color: #fff1f0 !important; }
        .column-at-wip-limit { border: 2px solid #ff7875; }
        .column-at-wip-limit .column-header .task-count-badge::after { /* Updated to target badge */
            content: " (WIP Limit!)"; color: #ff4d4f; font-weight: bold; font-size: 0.8em; margin-left: 5px;
        }

        /* Modal Styling */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff; margin: auto; padding: 30px; border: none; border-radius: 8px;
            width: 90%; max-width: 600px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            animation: modalFadeIn 0.3s ease-out;
        }
        #archived-tasks-modal .modal-content { max-width: 700px; }
        #archived-tasks-list { max-height: 60vh; overflow-y: auto; }
        #archived-tasks-list p { margin-top: 10px; text-align: center; color: #595959; }

        @keyframes modalFadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content h3 {
            margin-top: 0; color: #1890ff; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; font-weight: 600;
        }
        .modal-content label { display: block; margin-top: 15px; margin-bottom: 8px; font-weight: 500; color: #595959; }
        .modal-content input[type="text"],
        .modal-content input[type="date"],
        .modal-content textarea,
        .modal-content select {
            width: 100%; box-sizing: border-box; padding: 12px; margin-bottom: 15px;
            border: 1px solid #d9d9d9; border-radius: 6px; font-size: 1rem;
        }
        .modal-content input[type="text"]:focus,
        .modal-content input[type="date"]:focus,
        .modal-content textarea:focus,
        .modal-content select:focus {
            border-color: #1890ff; box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2); outline: none;
        }
        .modal-content input[type="checkbox"] {
            margin-right: 8px; vertical-align: middle; width: auto; height: 1.1em; accent-color: #1890ff;
        }
        .modal-content .block-reason-container { margin-top: 10px; }
        .modal-content textarea { min-height: 90px; resize: vertical; }
        .modal-buttons { margin-top: 25px; text-align: right; }
        .modal-buttons button {
            padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 1rem;
            border: none; margin-left: 12px; font-weight: 500;
            transition: background-color 0.3s, transform 0.1s;
        }
        .modal-buttons .save-btn { background-color: #1890ff; color: white; }
        .modal-buttons .save-btn:hover { background-color: #40a9ff; }
        .modal-buttons .cancel-btn { background-color: #f0f0f0; color: #595959; border: 1px solid #d9d9d9;}
        .modal-buttons .cancel-btn:hover { background-color: #e0e0e0; }
        .modal-buttons button:active { transform: scale(0.98); }
        .close-modal-btn {
            color: #aaa; float: right; font-size: 32px; font-weight: bold; line-height: 1;
        }
        .close-modal-btn:hover, .close-modal-btn:focus { color: #595959; text-decoration: none; cursor: pointer; }

        /* Custom Alert Styling */
        .custom-alert-overlay { /* ... */ }
        .custom-alert-box { /* ... */ }
        .custom-alert-box p { /* ... */ }
        .custom-alert-box button { /* ... */ }
        .custom-alert-box button:hover { /* ... */ }

        @media (max-width: 767px) { /* md breakpoint for mobile */
            #kanban-mobile-tabs {
                display: flex;
            }
            .kanban-board {
                display: block;
            }
            .kanban-column {
                width: 100%;
                margin-bottom: 0;
                display: none; /* Hide all columns by default on mobile */
                background-color: #fff; /* Reset column background on mobile */
                padding-top: 10px;
            }
            .kanban-column.active-mobile-column {
                display: flex; /* Show only the active column */
            }
            .kanban-column .column-header { /* Hide desktop column header on mobile */
                display: none;
            }
             .tasks-container.empty {
                background-color: transparent;
            }
            .fab-add-task { bottom: 20px; right: 20px; width: 56px; height: 56px; font-size: 24px; line-height: 56px; }
            .actions-bar-container { justify-content: space-between; }
        }
        @media (min-width: 768px) and (max-width: 1250px) {
            .kanban-board { justify-content: flex-start; gap: 10px; }
            .kanban-column { width: calc(50% - 10px); margin-bottom: 20px; }
        }
        @media (max-width: 991px) {
             .filter-bar .actions { grid-column: 1 / -1; justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header id="app-main-header">
            <h1>Ghi ch√∫ Kanban</h1>
        </header>

        <div class="actions-bar-container">
            <button id="view-archived-btn"><span class="icon">üóÑÔ∏è</span> Xem L∆∞u Tr·ªØ</button>
            <button id="toggle-filter-bar-btn"><span class="icon">‚ò∞</span> <span id="toggle-filter-text">Hi·ªán B·ªô L·ªçc</span></button>
        </div>

        <div class="filter-bar" id="filter-bar">
            <div class="form-group"> <label for="search-term-input">T√¨m theo ti√™u ƒë·ªÅ:</label> <input type="text" id="search-term-input" placeholder="Nh·∫≠p t·ª´ kh√≥a..."> </div>
            <div class="form-group"> <label for="filter-priority">L·ªçc theo ∆∞u ti√™n:</label> <select id="filter-priority"> <option value="">T·∫•t c·∫£ ∆∞u ti√™n</option> <option value="high">Cao</option> <option value="medium">Trung b√¨nh</option> <option value="low">Th·∫•p</option> </select> </div>
            <div class="form-group"> <label for="filter-assignee">L·ªçc theo ng∆∞·ªùi th·ª±c hi·ªán:</label> <select id="filter-assignee"> <option value="">T·∫•t c·∫£ ng∆∞·ªùi th·ª±c hi·ªán</option> </select> </div>
            <div class="form-group"> <label for="filter-tag">L·ªçc theo th·∫ª:</label> <select id="filter-tag"> <option value="">T·∫•t c·∫£ th·∫ª</option> </select> </div>
            <div class="form-group"> <label for="filter-blocked">L·ªçc theo tr·∫°ng th√°i ch·∫∑n:</label> <select id="filter-blocked"> <option value="">T·∫•t c·∫£</option> <option value="yes">B·ªã ch·∫∑n</option> <option value="no">Kh√¥ng b·ªã ch·∫∑n</option> </select> </div>
            <div class="form-group"> <label for="filter-due-date">L·ªçc theo ng√†y ƒë·∫øn h·∫°n:</label> <select id="filter-due-date"> <option value="">T·∫•t c·∫£ ng√†y</option> <option value="overdue">Qu√° h·∫°n</option> <option value="today">H√¥m nay</option> <option value="next7days">Trong 7 ng√†y t·ªõi</option> <option value="noduedate">Kh√¥ng c√≥ ng√†y ƒë·∫øn h·∫°n</option> </select> </div>
            <div class="actions"> <button id="apply-filters-btn">√Åp d·ª•ng l·ªçc</button> <button id="clear-filters-btn" class="clear-filter-btn">X√≥a b·ªô l·ªçc</button> </div>
        </div>

        <div id="kanban-mobile-tabs">
            <button class="mobile-tab-button active-tab" id="tab-todo" data-status="todo">
                <span class="icon">üìù</span>C·∫ßn l√†m
            </button>
            <button class="mobile-tab-button" id="tab-inprogress" data-status="inprogress">
                <span class="icon">‚öôÔ∏è</span>ƒêang l√†m
            </button>
            <button class="mobile-tab-button" id="tab-done" data-status="done">
                <span class="icon">‚úîÔ∏è</span>Ho√†n th√†nh
            </button>
        </div>

        <button id="fab-add-task" class="fab-add-task" title="Th√™m c√¥ng vi·ªác m·ªõi">+</button>

        <div class="kanban-board">
            <div class="kanban-column" id="todo" data-status="todo" data-wip-limit="-1">
                <div class="column-header">
                    <span class="title-group">
                        <svg class="column-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 3.75h7.5M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                        <h2>C·∫ßn l√†m</h2>
                    </span>
                    <span class="task-count-badge" id="todo-count">0</span>
                </div>
                <div class="tasks-container"></div>
            </div>
            <div class="kanban-column" id="inprogress" data-status="inprogress" data-wip-limit="3">
                 <div class="column-header">
                    <span class="title-group">
                        <svg class="column-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                        <h2>ƒêang l√†m</h2>
                    </span>
                    <span class="task-count-badge" id="inprogress-count">0</span>
                </div>
                <div class="tasks-container"></div>
            </div>
            <div class="kanban-column" id="done" data-status="done" data-wip-limit="-1">
                 <div class="column-header">
                    <span class="title-group">
                        <svg class="column-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <h2>Ho√†n th√†nh</h2>
                    </span>
                    <span class="task-count-badge" id="done-count">0</span>
                </div>
                <div class="tasks-container"></div>
            </div>
        </div>
    </div>

    <div id="add-task-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="close-add-task-modal-btn">&times;</span>
            <h3>Th√™m c√¥ng vi·ªác m·ªõi</h3>
            <label for="add-modal-task-title">Ti√™u ƒë·ªÅ:</label>
            <input type="text" id="add-modal-task-title" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ...">
            <label for="add-modal-task-desc">M√¥ t·∫£:</label>
            <textarea id="add-modal-task-desc" placeholder="M√¥ t·∫£ chi ti·∫øt (t√πy ch·ªçn)..."></textarea>
            <label for="add-modal-task-status">Tr·∫°ng th√°i:</label>
            <select id="add-modal-task-status">
                <option value="todo">C·∫ßn l√†m</option>
                <option value="inprogress">ƒêang l√†m</option>
                <option value="done">Ho√†n th√†nh</option>
            </select>
            <label for="add-modal-task-priority">ƒê·ªô ∆∞u ti√™n:</label>
            <select id="add-modal-task-priority">
                <option value="medium">Trung b√¨nh</option>
                <option value="high">Cao</option>
                <option value="low">Th·∫•p</option>
            </select>
            <label for="add-modal-task-due-date">Ng√†y ƒë·∫øn h·∫°n:</label>
            <input type="date" id="add-modal-task-due-date">
            <label for="add-modal-task-assignee">Ng∆∞·ªùi th·ª±c hi·ªán:</label>
            <input type="text" id="add-modal-task-assignee" placeholder="T√™n ng∆∞·ªùi th·ª±c hi·ªán...">
            <label for="add-modal-task-tags">Th·∫ª (c√°ch nhau b·ªüi d·∫•u ph·∫©y):</label>
            <input type="text" id="add-modal-task-tags" placeholder="V√≠ d·ª•: bug, feature, urgent">
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" id="cancel-add-task-btn">H·ªßy</button>
                <button type="button" class="save-btn" id="save-new-task-btn">Th√™m Task</button>
            </div>
        </div>
    </div>

    <div id="edit-task-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="close-edit-modal-btn">&times;</span>
            <h3>Ch·ªânh s·ª≠a c√¥ng vi·ªác</h3>
            <input type="hidden" id="edit-task-id">
            <label for="edit-task-title">Ti√™u ƒë·ªÅ:</label>
            <input type="text" id="edit-task-title">
            <label for="edit-task-description">M√¥ t·∫£:</label>
            <textarea id="edit-task-description"></textarea>
            <label for="edit-task-status">Tr·∫°ng th√°i:</label>
            <select id="edit-task-status">
                <option value="todo">C·∫ßn l√†m</option>
                <option value="inprogress">ƒêang l√†m</option>
                <option value="done">Ho√†n th√†nh</option>
            </select>
            <label for="edit-task-priority">ƒê·ªô ∆∞u ti√™n:</label>
            <select id="edit-task-priority">
                <option value="low">Th·∫•p</option>
                <option value="medium">Trung b√¨nh</option>
                <option value="high">Cao</option>
            </select>
            <label for="edit-task-due-date">Ng√†y ƒë·∫øn h·∫°n:</label>
            <input type="date" id="edit-task-due-date">
            <label for="edit-task-assignee">Ng∆∞·ªùi th·ª±c hi·ªán:</label>
            <input type="text" id="edit-task-assignee" placeholder="T√™n ng∆∞·ªùi th·ª±c hi·ªán...">
            <label for="edit-task-tags">Th·∫ª (c√°ch nhau b·ªüi d·∫•u ph·∫©y):</label>
            <input type="text" id="edit-task-tags" placeholder="V√≠ d·ª•: bug, feature, urgent">
            <div>
                <label for="edit-task-blocked">
                    <input type="checkbox" id="edit-task-blocked"> B·ªã ch·∫∑n?
                </label>
            </div>
            <div class="block-reason-container" id="edit-block-reason-container" style="display: none;">
                <label for="edit-task-block-reason">L√Ω do b·ªã ch·∫∑n:</label>
                <textarea id="edit-task-block-reason"></textarea>
            </div>
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" id="cancel-edit-task-btn">H·ªßy</button>
                <button type="button" class="save-btn" id="save-edit-task-btn">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <div id="archived-tasks-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="close-archived-modal-btn">&times;</span>
            <h3>C√¥ng vi·ªác ƒë√£ l∆∞u tr·ªØ</h3>
            <div id="archived-tasks-list">
                <p>Ch·ª©c nƒÉng xem c√¥ng vi·ªác ƒë√£ l∆∞u tr·ªØ s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn sau.</p>
            </div>
        </div>
    </div>

    <div id="custom-alert-overlay" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <p id="custom-alert-message"></p>
            <button id="custom-alert-ok-btn">OK</button>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
      import {
          getFirestore, collection, addDoc, query, onSnapshot,
          doc, updateDoc, deleteDoc, serverTimestamp
      } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCWfij5n2cTb1jGkUreaLtwi7IENVxssbc",
        authDomain: "testeng-7782.firebaseapp.com",
        projectId: "testeng-7782",
        storageBucket: "testeng-7782.firebasestorage.app",
        messagingSenderId: "741104739298",
        appId: "1:741104739298:web:fde4d379f83c139c33cfbb"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // === DOM Elements (General & Header) ===
      const kanbanColumns = document.querySelectorAll('.kanban-column');
      const customAlertOverlay = document.getElementById('custom-alert-overlay');
      const customAlertMessage = document.getElementById('custom-alert-message');
      const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
      const toggleFilterBarBtn = document.getElementById('toggle-filter-bar-btn');
      const toggleFilterText = document.getElementById('toggle-filter-text');
      const viewArchivedBtn = document.getElementById('view-archived-btn');
      const filterBar = document.getElementById('filter-bar');
      const searchTermInput = document.getElementById('search-term-input');
      const filterPrioritySelect = document.getElementById('filter-priority');
      const filterAssigneeSelect = document.getElementById('filter-assignee');
      const filterTagSelect = document.getElementById('filter-tag');
      const filterBlockedSelect = document.getElementById('filter-blocked');
      const filterDueDateSelect = document.getElementById('filter-due-date');
      const applyFiltersBtn = document.getElementById('apply-filters-btn');
      const clearFiltersBtn = document.getElementById('clear-filters-btn');

      // === DOM Elements (Mobile Tabs) ===
      const kanbanMobileTabs = document.getElementById('kanban-mobile-tabs');
      const mobileTabButtons = document.querySelectorAll('.mobile-tab-button');
      let currentActiveMobileColumnId = 'todo';

      // === DOM Elements (Add Task FAB & Modal) ===
      const fabAddTaskBtn = document.getElementById('fab-add-task');
      const addTaskModal = document.getElementById('add-task-modal');
      const closeAddTaskModalBtn = document.getElementById('close-add-task-modal-btn');
      const cancelAddTaskBtn = document.getElementById('cancel-add-task-btn');
      const saveNewTaskBtn = document.getElementById('save-new-task-btn');
      const addModalTaskTitleInput = document.getElementById('add-modal-task-title');
      const addModalTaskDescInput = document.getElementById('add-modal-task-desc');
      const addModalTaskStatusInput = document.getElementById('add-modal-task-status');
      const addModalTaskPriorityInput = document.getElementById('add-modal-task-priority');
      const addModalTaskDueDateInput = document.getElementById('add-modal-task-due-date');
      const addModalTaskAssigneeInput = document.getElementById('add-modal-task-assignee');
      const addModalTaskTagsInput = document.getElementById('add-modal-task-tags');

      // === DOM Elements (Edit Task Modal) ===
      const editTaskModal = document.getElementById('edit-task-modal');
      const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
      const cancelEditTaskBtn = document.getElementById('cancel-edit-task-btn');
      const saveEditTaskBtn = document.getElementById('save-edit-task-btn');
      const editTaskIdInput = document.getElementById('edit-task-id');
      const editTaskTitleInput = document.getElementById('edit-task-title');
      const editTaskDescInput = document.getElementById('edit-task-description');
      const editTaskStatusInput = document.getElementById('edit-task-status');
      const editTaskPriorityInput = document.getElementById('edit-task-priority');
      const editTaskDueDateInput = document.getElementById('edit-task-due-date');
      const editTaskAssigneeInput = document.getElementById('edit-task-assignee');
      const editTaskTagsInput = document.getElementById('edit-task-tags');
      const editTaskBlockedCheckbox = document.getElementById('edit-task-blocked');
      const editBlockReasonContainer = document.getElementById('edit-block-reason-container');
      const editTaskBlockReasonInput = document.getElementById('edit-task-block-reason');

      // === DOM Elements (Archived Tasks Modal) ===
      const archivedTasksModal = document.getElementById('archived-tasks-modal');
      const closeArchivedModalBtn = document.getElementById('close-archived-modal-btn');
      const archivedTasksList = document.getElementById('archived-tasks-list');


      let draggedTask = null;
      let currentEditingTaskId = null;
      const TASKS_COLLECTION = 'tasks_kanban_public_v12_col_ui';
      const priorityMap = { high: 'Cao', medium: 'Trung b√¨nh', low: 'Th·∫•p' };
      let currentTaskCounts = { todo: 0, inprogress: 0, done: 0 };
      let allTasks = [];

      // === Custom Alert Function ===
      function showAlert(message) { customAlertMessage.textContent = message; customAlertOverlay.style.display = 'flex'; }
      customAlertOkBtn.addEventListener('click', () => { customAlertOverlay.style.display = 'none'; });

      // === Helper Functions ===
      function formatDateForDisplay(dateString) {
          if (!dateString) return 'N/A';
          const date = new Date(dateString);
          const userTimezoneOffset = date.getTimezoneOffset() * 60000;
          const correctedDate = new Date(date.getTime() + userTimezoneOffset);
          return correctedDate.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }
      function getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // === Add Task Modal Logic ===
      function openAddTaskModal() {
        addModalTaskTitleInput.value = ''; addModalTaskDescInput.value = '';
        addModalTaskStatusInput.value = 'todo'; addModalTaskPriorityInput.value = 'medium';
        addModalTaskDueDateInput.value = ''; addModalTaskAssigneeInput.value = ''; addModalTaskTagsInput.value = '';
        addTaskModal.style.display = 'flex';
      }
      function closeAddTaskModal() { addTaskModal.style.display = 'none'; }
      fabAddTaskBtn.addEventListener('click', openAddTaskModal);
      closeAddTaskModalBtn.addEventListener('click', closeAddTaskModal);
      cancelAddTaskBtn.addEventListener('click', closeAddTaskModal);
      saveNewTaskBtn.addEventListener('click', () => {
          const title = addModalTaskTitleInput.value; const description = addModalTaskDescInput.value;
          const status = addModalTaskStatusInput.value; const priority = addModalTaskPriorityInput.value;
          const dueDate = addModalTaskDueDateInput.value; const assignee = addModalTaskAssigneeInput.value.trim();
          const tags = addModalTaskTagsInput.value.trim();
          addTaskToFirestore(title, description, status, priority, dueDate, assignee, tags);
      });

      // === Edit Task Modal Logic ===
      editTaskBlockedCheckbox.addEventListener('change', function() {
          editBlockReasonContainer.style.display = this.checked ? 'block' : 'none';
          if (!this.checked) editTaskBlockReasonInput.value = '';
      });
      function openEditModal(task) {
          currentEditingTaskId = task.id; editTaskIdInput.value = task.id;
          editTaskTitleInput.value = task.title; editTaskDescInput.value = task.description || '';
          editTaskStatusInput.value = task.status; editTaskPriorityInput.value = task.priority || 'medium';
          editTaskDueDateInput.value = task.dueDate || ''; editTaskAssigneeInput.value = task.assignee || '';
          editTaskTagsInput.value = Array.isArray(task.tags) ? task.tags.join(', ') : '';
          editTaskBlockedCheckbox.checked = task.isBlocked || false;
          editTaskBlockReasonInput.value = task.blockReason || '';
          editBlockReasonContainer.style.display = editTaskBlockedCheckbox.checked ? 'block' : 'none';
          editTaskModal.style.display = 'flex';
      }
      function closeEditModal() { editTaskModal.style.display = 'none'; currentEditingTaskId = null; }
      closeEditModalBtn.onclick = closeEditModal;
      cancelEditTaskBtn.onclick = closeEditModal;
      saveEditTaskBtn.addEventListener('click', async () => {
          if (!currentEditingTaskId) return;
          const updatedTitle = editTaskTitleInput.value.trim(); const updatedDescription = editTaskDescInput.value.trim();
          const updatedStatus = editTaskStatusInput.value; const updatedPriority = editTaskPriorityInput.value;
          const updatedDueDate = editTaskDueDateInput.value; const updatedAssignee = editTaskAssigneeInput.value.trim();
          const updatedTagsString = editTaskTagsInput.value.trim();
          const updatedTags = updatedTagsString ? updatedTagsString.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
          const isBlocked = editTaskBlockedCheckbox.checked;
          const blockReason = isBlocked ? editTaskBlockReasonInput.value.trim() : "";

          if (!updatedTitle) { showAlert("Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!"); return; }
          if (isBlocked && !blockReason) { showAlert("Vui l√≤ng nh·∫≠p l√Ω do b·ªã ch·∫∑n!"); return; }

          try {
              const taskRef = doc(db, TASKS_COLLECTION, currentEditingTaskId);
              await updateDoc(taskRef, {
                  title: updatedTitle, description: updatedDescription, status: updatedStatus,
                  priority: updatedPriority, dueDate: updatedDueDate, assignee: updatedAssignee,
                  tags: updatedTags, isBlocked: isBlocked, blockReason: blockReason,
                  updatedAt: serverTimestamp()
              });
              showAlert("C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng!"); closeEditModal();
          } catch (error) { console.error("Error updating task:", error); showAlert("L·ªói c·∫≠p nh·∫≠t task: " + error.message); }
      });

      // === Archived Tasks Modal Logic ===
      function openArchivedTasksModal() {
          archivedTasksList.innerHTML = '<p>Ch·ª©c nƒÉng xem c√¥ng vi·ªác ƒë√£ l∆∞u tr·ªØ s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn ·ªü c√°c phi√™n b·∫£n sau.</p>';
          archivedTasksModal.style.display = 'flex';
      }
      function closeArchivedTasksModal() { archivedTasksModal.style.display = 'none'; }
      viewArchivedBtn.addEventListener('click', openArchivedTasksModal);
      closeArchivedModalBtn.addEventListener('click', closeArchivedTasksModal);

      // === Window OnClick for Modals ===
      window.onclick = function(event) {
          if (event.target == editTaskModal) closeEditModal();
          if (event.target == addTaskModal) closeAddTaskModal();
          if (event.target == archivedTasksModal) closeArchivedTasksModal();
          if (event.target == customAlertOverlay) customAlertOverlay.style.display = 'none';
      };

      // === Kanban App Logic ===
      function updateColumnUI() {
          kanbanColumns.forEach(column => {
              const status = column.dataset.status;
              const countBadge = column.querySelector('.task-count-badge');
              const wipLimit = parseInt(column.dataset.wipLimit, 10);
              const currentCount = currentTaskCounts[status] || 0;
              if (countBadge) countBadge.textContent = currentCount;
              column.classList.remove('wip-limit-exceeded', 'column-at-wip-limit');
              if (wipLimit !== -1 && currentCount >= wipLimit) {
                  column.classList.add('column-at-wip-limit');
              }
          });
      }

      async function addTaskToFirestore(title, description, status, priority, dueDate, assignee, tagsString) {
        if (!title.trim()) { showAlert("Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!"); return; }
        const columnElement = document.getElementById(status);
        if (!columnElement) { showAlert(`L·ªói: Kh√¥ng t√¨m th·∫•y c·ªôt cho tr·∫°ng th√°i "${status}".`); return; }
        const wipLimit = parseInt(columnElement.dataset.wipLimit, 10);
        if (wipLimit !== -1 && currentTaskCounts[status] >= wipLimit) {
            showAlert(`C·ªôt "${columnElement.querySelector('h2').textContent.trim()}" ƒë√£ ƒë·∫°t gi·ªõi h·∫°n WIP (${wipLimit}). Kh√¥ng th·ªÉ th√™m task m·ªõi.`); return;
        }
        const tagsArray = tagsString ? tagsString.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
        try {
            await addDoc(collection(db, TASKS_COLLECTION), {
                title, description, status, priority, dueDate, assignee,
                tags: tagsArray, isBlocked: false, blockReason: "", createdAt: serverTimestamp()
            });
            showAlert("Th√™m c√¥ng vi·ªác m·ªõi th√†nh c√¥ng!"); closeAddTaskModal();
        } catch (e) { showAlert("L·ªói th√™m task: " + e.message); }
      }

      function createTaskCard(taskData) {
        const taskCard = document.createElement('div');
        taskCard.classList.add('task-card');
        taskCard.setAttribute('draggable', 'true');
        taskCard.dataset.id = taskData.id;
        taskCard.dataset.status = taskData.status;
        taskCard.dataset.priority = taskData.priority || 'medium';

        taskCard.classList.remove('priority-high', 'priority-medium', 'priority-low', 'blocked', 'due-overdue', 'due-soon');
        taskCard.classList.add(`priority-${taskData.priority || 'medium'}`);
        if (taskData.isBlocked) taskCard.classList.add('blocked');

        if (taskData.dueDate) {
            const today = getTodayDateString(); const dueDate = taskData.dueDate;
            if (dueDate < today) taskCard.classList.add('due-overdue');
            else {
                const todayDate = new Date(today); const dueDateObj = new Date(dueDate);
                const diffTime = dueDateObj - todayDate; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays <= 1 && diffDays >=0) taskCard.classList.add('due-soon');
            }
        }
        const contentWrapper = document.createElement('div');
        contentWrapper.classList.add('task-card-content');
        contentWrapper.onclick = (event) => { if (event.target.closest('.delete-btn')) return; openEditModal(taskData); };
        const titleElement = document.createElement('h4'); titleElement.textContent = taskData.title;
        const descElement = document.createElement('p'); descElement.classList.add('task-description'); descElement.textContent = taskData.description || '';
        contentWrapper.appendChild(titleElement); contentWrapper.appendChild(descElement);
        const detailsDiv = document.createElement('div'); detailsDiv.classList.add('task-details');
        if (taskData.assignee) {
            const assigneeP = document.createElement('p'); assigneeP.classList.add('task-detail-item');
            assigneeP.innerHTML = `<strong>Ng∆∞·ªùi th·ª±c hi·ªán:</strong> ${taskData.assignee}`; detailsDiv.appendChild(assigneeP);
        }
        if (taskData.dueDate) {
            const dueDateP = document.createElement('p'); dueDateP.classList.add('task-detail-item');
            const dueDateSpan = document.createElement('span'); dueDateSpan.classList.add('due-date');
            dueDateSpan.textContent = formatDateForDisplay(taskData.dueDate);
            const today = getTodayDateString();
            if (taskData.dueDate < today) dueDateSpan.classList.add('overdue');
            else {
                const todayDate = new Date(today); const dueDateObj = new Date(taskData.dueDate);
                const diffTime = dueDateObj - todayDate; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays <= 1 && diffDays >=0) dueDateSpan.classList.add('soon');
            }
            dueDateP.innerHTML = `<strong>ƒê·∫øn h·∫°n:</strong> `; dueDateP.appendChild(dueDateSpan); detailsDiv.appendChild(dueDateP);
        }
        if (detailsDiv.hasChildNodes()) contentWrapper.appendChild(detailsDiv);
        if (taskData.tags && taskData.tags.length > 0) {
            const tagsDiv = document.createElement('div'); tagsDiv.classList.add('task-tags');
            taskData.tags.forEach(tagText => {
                const tagSpan = document.createElement('span'); tagSpan.classList.add('task-tag');
                tagSpan.textContent = tagText; tagsDiv.appendChild(tagSpan);
            });
            contentWrapper.appendChild(tagsDiv);
        }
        const metaDiv = document.createElement('div'); metaDiv.classList.add('task-meta');
        const createdAtSpan = document.createElement('span');
        createdAtSpan.textContent = `T·∫°o: ${taskData.createdAt && taskData.createdAt.toDate ? formatDateForDisplay(taskData.createdAt.toDate().toISOString().split('T')[0]) : 'N/A'}`;
        const priorityLabelSpan = document.createElement('span'); priorityLabelSpan.classList.add('task-priority-label');
        priorityLabelSpan.textContent = priorityMap[taskData.priority || 'medium'] || 'Trung b√¨nh';
        metaDiv.appendChild(createdAtSpan); metaDiv.appendChild(priorityLabelSpan);
        contentWrapper.appendChild(metaDiv);
        if (taskData.isBlocked) {
            const blockedInfoWrapper = document.createElement('div'); blockedInfoWrapper.classList.add('blocked-icon-wrapper');
            const blockedSpan = document.createElement('span'); blockedSpan.classList.add('blocked-icon');
            blockedSpan.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" style="width:1em;height:1em;margin-right:4px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-5h2v2h-2v-2zm0-8h2v6h-2V7z"></path></svg> B·ªä CH·∫∂N`;
            blockedInfoWrapper.appendChild(blockedSpan);
            if (taskData.blockReason) {
                const reasonText = document.createElement('span'); reasonText.classList.add('block-reason-text');
                reasonText.textContent = taskData.blockReason; blockedInfoWrapper.appendChild(reasonText);
                blockedSpan.title = `L√Ω do: ${taskData.blockReason}`;
            }
            contentWrapper.appendChild(blockedInfoWrapper);
        }
        const deleteBtn = document.createElement('button'); deleteBtn.classList.add('delete-btn');
        deleteBtn.innerHTML = '&times; X√≥a'; deleteBtn.title = "X√≥a c√¥ng vi·ªác n√†y";
        deleteBtn.onclick = (event) => { event.stopPropagation(); if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác "${taskData.title}" kh√¥ng?`)) deleteTask(taskData.id); };
        const actionsDiv = document.createElement('div'); actionsDiv.classList.add('task-actions'); actionsDiv.appendChild(deleteBtn);
        taskCard.appendChild(contentWrapper); taskCard.appendChild(actionsDiv);
        taskCard.addEventListener('dragstart', handleDragStart); taskCard.addEventListener('dragend', handleDragEnd);
        return taskCard;
      }

      async function updateTaskStatusInFirestore(taskId, newStatus, oldStatus) {
          const columnElement = document.getElementById(newStatus);
          if (!columnElement) { showAlert(`L·ªói: Kh√¥ng t√¨m th·∫•y c·ªôt cho tr·∫°ng th√°i "${newStatus}".`); return false; }
          const wipLimit = parseInt(columnElement.dataset.wipLimit, 10);
          if (wipLimit !== -1 && currentTaskCounts[newStatus] >= wipLimit && newStatus !== oldStatus) {
             showAlert(`C·ªôt "${columnElement.querySelector('.column-header h2').textContent.trim()}" ƒë√£ ƒë·∫°t gi·ªõi h·∫°n WIP (${wipLimit}). Kh√¥ng th·ªÉ chuy·ªÉn task.`); return false;
          }
          try {
              const taskRef = doc(db, TASKS_COLLECTION, taskId);
              await updateDoc(taskRef, { status: newStatus, updatedAt: serverTimestamp() }); return true;
          } catch (error) { showAlert("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i task: " + error.message); return false; }
      }
      async function deleteTask(taskId) {
          try { await deleteDoc(doc(db, TASKS_COLLECTION, taskId)); showAlert("X√≥a c√¥ng vi·ªác th√†nh c√¥ng!"); }
          catch (error) { showAlert("L·ªói x√≥a task: " + error.message); }
      }

      // --- Drag and Drop Handlers ---
      function handleDragStart(event) { /* ... (Unchanged) */ }
      function handleDragEnd(event) { /* ... (Unchanged) */ }
      kanbanColumns.forEach(column => { /* ... (Unchanged dragover, dragleave, drop listeners) */ });

      // === Filtering Logic ===
      toggleFilterBarBtn.addEventListener('click', () => {
          filterBar.classList.toggle('filter-bar-visible');
          const buttonTextSpan = toggleFilterBarBtn.querySelector('#toggle-filter-text');
          if (filterBar.classList.contains('filter-bar-visible')) {
              if(buttonTextSpan) buttonTextSpan.textContent = '·∫®n B·ªô L·ªçc';
          } else {
              if(buttonTextSpan) buttonTextSpan.textContent = 'Hi·ªán B·ªô L·ªçc';
          }
      });
      function populateFilterOptions() { /* ... (Unchanged) */ }
      function applyAllFilters() { /* ... (Unchanged) */ }
      function renderFilteredTasks(tasksToRender) {
          kanbanColumns.forEach(column => {
              const container = column.querySelector('.tasks-container');
              container.innerHTML = '';
              container.classList.remove('empty');
          });
          currentTaskCounts = { todo: 0, inprogress: 0, done: 0 };
          let hasActiveFilters = searchTermInput.value || filterPrioritySelect.value || filterAssigneeSelect.value || filterTagSelect.value || filterBlockedSelect.value || filterDueDateSelect.value;

          if (tasksToRender.length === 0) {
              const emptyIconSvg = `<svg class="empty-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>`;
              let message = hasActiveFilters ? 'Kh√¥ng c√≥ c√¥ng vi·ªác n√†o kh·ªõp v·ªõi b·ªô l·ªçc.' : 'Ch∆∞a c√≥ c√¥ng vi·ªác n√†o.';

              kanbanColumns.forEach(column => {
                  const container = column.querySelector('.tasks-container');
                  const tasksForThisColumn = tasksToRender.filter(t => t.status === column.dataset.status);
                  if (tasksForThisColumn.length === 0) { // Only show empty message if this column is truly empty for the current filter/view
                    container.innerHTML = `${emptyIconSvg}<p>${message}</p>`;
                    container.classList.add('empty');
                  }
              });
          } else {
            tasksToRender.forEach((taskData) => {
                if (!taskData.status || !currentTaskCounts.hasOwnProperty(taskData.status)) {
                    taskData.status = 'todo';
                }
                currentTaskCounts[taskData.status]++;
                const taskCardElement = createTaskCard(taskData);
                const columnContainer = document.getElementById(taskData.status)?.querySelector('.tasks-container');
                if (columnContainer) {
                    columnContainer.appendChild(taskCardElement);
                }
            });
          }
          updateColumnUI();
          handleMobileLayout(); // Adjust layout after rendering
      }
      applyFiltersBtn.addEventListener('click', applyAllFilters);
      clearFiltersBtn.addEventListener('click', () => { /* ... (Unchanged) */ });

      // === Mobile Tab Logic ===
      function setActiveMobileColumn(status) {
          currentActiveMobileColumnId = status;
          mobileTabButtons.forEach(btn => {
              btn.classList.remove('active-tab');
              if (btn.dataset.status === status) {
                  btn.classList.add('active-tab');
              }
          });
          kanbanColumns.forEach(col => {
              if (col.id === status) {
                  col.classList.add('active-mobile-column');
                  col.style.display = 'flex'; // Ensure it's flex for internal layout
              } else {
                  col.classList.remove('active-mobile-column');
                  col.style.display = 'none';
              }
          });
      }

      mobileTabButtons.forEach(button => {
          button.addEventListener('click', () => {
              setActiveMobileColumn(button.dataset.status);
          });
      });

      function handleMobileLayout() {
          if (window.innerWidth < 768) {
              kanbanMobileTabs.style.display = 'flex';
              setActiveMobileColumn(currentActiveMobileColumnId); // Ensure correct tab is shown
          } else {
              kanbanMobileTabs.style.display = 'none';
              kanbanColumns.forEach(col => {
                  col.style.display = 'flex'; // Show all columns on desktop
                  col.classList.remove('active-mobile-column');
              });
          }
      }
      window.addEventListener('resize', handleMobileLayout);


      // === Firestore Real-time Listener ===
      const q = query(collection(db, TASKS_COLLECTION));
      onSnapshot(q, (querySnapshot) => {
          allTasks = [];
          querySnapshot.forEach((docSnap) => {
            allTasks.push({ ...docSnap.data(), id: docSnap.id });
          });
          allTasks.sort((a, b) => {
            if (a.isPinned && !b.isPinned) return -1;
            if (!a.isPinned && b.isPinned) return 1;
            if (a.createdAt && b.createdAt) {
                return b.createdAt.toMillis() - a.createdAt.toMillis();
            } else if (a.createdAt) { return -1; }
            else if (b.createdAt) { return 1; }
            return 0;
          });
          populateFilterOptions();
          applyAllFilters(); // This will call renderFilteredTasks, which calls handleMobileLayout
      }, (error) => {
          console.error("Error fetching tasks with onSnapshot: ", error);
          showAlert("L·ªói t·∫£i danh s√°ch c√¥ng vi·ªác: " + error.message);
      });

      // Initial layout check
      handleMobileLayout();

    </script>
</body>
</html>
