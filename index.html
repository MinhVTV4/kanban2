<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng Kanban Task (Bottom Sheet & Th·∫ª T√≥m T·∫Øt)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.6;
            overscroll-behavior: none;
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            margin-bottom: 20px;
        }

        #app-main-header {
            text-align: center;
            margin-bottom: 20px;
        }
        #app-main-header h1 {
            color: #1890ff;
            font-weight: 600;
            font-size: 1.75rem;
            margin: 0;
        }

        .actions-bar-container {
            background-color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .actions-bar-container button {
            padding: 10px 18px; color: white; border: none; border-radius: 6px;
            cursor: pointer; font-size: 0.9rem; font-weight: 500;
            transition: background-color 0.3s ease; display: flex; align-items: center;
        }
        .actions-bar-container button .icon { margin-right: 8px; }
        #toggle-filter-bar-btn { background-color: #52c41a; }
        #toggle-filter-bar-btn:hover { background-color: #389e0d; }
        #view-archived-btn { background-color: #722ed1; }
        #view-archived-btn:hover { background-color: #531dab; }

        .filter-bar {
            background-color: #fff; padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin-bottom: 30px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; align-items: center; overflow: hidden; max-height: 0;
            opacity: 0; transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, padding-top 0.5s ease-in-out, padding-bottom 0.5s ease-in-out, margin-bottom 0.5s ease-in-out;
            padding-top: 0; padding-bottom: 0; margin-bottom: 0;
        }
        .filter-bar.filter-bar-visible {
            max-height: 1000px; opacity: 1; padding-top: 20px;
            padding-bottom: 20px; margin-bottom: 30px;
        }
        .filter-bar .form-group { display: flex; flex-direction: column; }
        .filter-bar label { font-size: 0.85rem; color: #595959; margin-bottom: 5px; }
        .filter-bar input[type="text"], .filter-bar select {
            padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px;
            font-size: 0.95rem; width: 100%; box-sizing: border-box;
        }
        .filter-bar input[type="text"]:focus, .filter-bar select:focus {
            border-color: #1890ff; box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2); outline: none;
        }
        .filter-bar .actions { grid-column: 1 / -1; display: flex; gap: 10px; justify-content: flex-end; }
         @media (min-width: 992px) { .filter-bar .actions { grid-column: auto; grid-row: 1; align-self: end; } }
        .filter-bar button {
            padding: 10px 15px; background-color: #1890ff; color: white;
            border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem;
            font-weight: 500; transition: background-color 0.3s ease;
        }
        .filter-bar button.clear-filter-btn { background-color: #ff4d4f; }
        .filter-bar button.clear-filter-btn:hover { background-color: #f5222d; }
        .filter-bar button:hover { background-color: #40a9ff; }

        .fab-add-task {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background-color: #1890ff; color: white; border: none; border-radius: 50%;
            font-size: 28px; line-height: 60px; text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease; z-index: 999;
        }
        .fab-add-task:hover { background-color: #40a9ff; transform: scale(1.1); }

        #kanban-mobile-tabs {
            display: none; background-color: #fff; border-bottom: 1px solid #e2e8f0;
            margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .mobile-tab-button {
            flex-grow: 1; text-align: center; padding: 12px 8px;
            font-size: 0.875rem; font-weight: 500; cursor: pointer;
            border-bottom: 3px solid transparent; color: #595959;
            transition: color 0.2s ease, border-color 0.2s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .mobile-tab-button .icon { margin-right: 6px; width: 16px; height: 16px; }
        .mobile-tab-button.active-tab { border-bottom-color: #1890ff; color: #1890ff; }
        .mobile-tab-button#tab-todo.active-tab { border-bottom-color: #eb2f96; color: #eb2f96; }
        .mobile-tab-button#tab-inprogress.active-tab { border-bottom-color: #faad14; color: #faad14; }
        .mobile-tab-button#tab-done.active-tab { border-bottom-color: #52c41a; color: #52c41a; }

        .kanban-board {
            display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start;
        }
        .kanban-column {
            flex: 1; min-width: 320px;
            border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column;
            transition: background-color 0.3s ease, border 0.3s ease;
        }
        .kanban-column#todo { background-color: #fff0f6; }
        .kanban-column#inprogress { background-color: #fffbe6; }
        .kanban-column#done { background-color: #f6ffed; }

        .kanban-column .column-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .kanban-column .column-header .title-group {
            display: flex; align-items: center; font-size: 1.15rem;
            font-weight: 600;
        }
        .kanban-column .column-header .column-icon { width: 18px; height: 18px; margin-right: 8px; }
        .kanban-column#todo .column-header .title-group { color: #c91368; }
        .kanban-column#inprogress .column-header .title-group { color: #d48806; }
        .kanban-column#done .column-header .title-group { color: #389e0d; }
        .kanban-column h2 { margin: 0; font-size: inherit; font-weight: inherit; color: inherit; border-bottom: none; padding-bottom: 0; }
        .kanban-column .task-count-badge {
            font-size: 0.75rem; color: #fff; padding: 2px 7px; border-radius: 10px;
            font-weight: 500; min-width: 22px; text-align: center;
        }
        .kanban-column#todo .task-count-badge { background-color: #eb2f96; }
        .kanban-column#inprogress .task-count-badge { background-color: #faad14; }
        .kanban-column#done .task-count-badge { background-color: #52c41a; }

        .tasks-container {
            padding: 0; min-height: 200px;
            flex-grow: 1;
        }
        .tasks-container.empty {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; color: #888; font-style: italic; min-height: 100px;
            padding: 20px 0; border: 2px dashed #d1d5db; border-radius: 6px; margin-top: 10px;
        }
        .tasks-container.empty .empty-icon { width: 32px; height: 32px; margin-bottom: 8px; opacity: 0.5; }

        /* Task Card Styling */
        .task-card {
            background-color: #ffffff; border: 1px solid #e0e0e0;
            border-left-width: 4px;
            border-radius: 6px; padding: 10px 12px; margin-bottom: 10px; cursor: grab;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: all 0.2s ease; position: relative;
            display: flex; flex-direction: column;
        }
        .task-card.task-pinned {
            background-color: #fef9c3;
            border: 1px solid #facc15;
            border-left-width: 4px !important;
        }

        .task-card-header {
            display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;
        }
        .task-card-title-text {
            font-size: 0.9rem; color: #1f2937; font-weight: 600;
            margin: 0; flex-grow: 1; word-break: break-word;
            overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2;
            -webkit-box-orient: vertical; line-height: 1.4; /* Adjusted for 2 lines */
            max-height: calc(1.4em * 2);
            /* No direct click for edit, use ... button */
        }
        .task-card-actions { display: flex; align-items: center; gap: 4px; margin-left: 8px; flex-shrink: 0;}
        .task-card-actions button {
            background: none; border: none; padding: 4px; cursor: pointer; color: #6b7280;
            display: flex; align-items: center; justify-content: center;
            width: 24px; height: 24px; border-radius: 4px;
        }
        .task-card-actions button:hover { background-color: #f3f4f6; color: #1f2937;}
        .task-card-actions button svg { width: 16px; height: 16px; }
        .task-card-actions .pin-btn.pinned svg { color: #f59e0b; }

        .task-card-minimal-indicators {
            display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
            font-size: 0.75rem; color: #6b7280; margin-top: 6px;
        }
        .task-due-date-indicator { /* For card summary */
            font-size: 0.7rem; padding: 1px 5px; border-radius: 3px;
        }
        .task-due-date-indicator.due-overdue { background-color: #fee2e2; color: #991b1b; }
        .task-due-date-indicator.due-soon { background-color: #fef3c7; color: #92400e; }
        .priority-indicator-badge { /* For card summary */
            padding: 1px 5px; border-radius: 3px; font-weight: 500; font-size: 0.7rem;
            color: white;
        }
        .priority-indicator-badge.prio-low { background-color: #22c55e; }
        .priority-indicator-badge.prio-medium { background-color: #f59e0b; }
        .priority-indicator-badge.prio-high { background-color: #ef4444; }


        .task-card-footer {
            margin-top: 8px; padding-top: 6px; border-top: 1px solid #f3f4f6;
            display: flex; justify-content: space-between; align-items: center;
        }
        .task-move-actions { /* Container for move buttons */
            display: flex;
            gap: 6px; /* Space between move buttons */
        }
        .task-move-actions button {
            background-color: #f3f4f6; /* Light gray background */
            border: 1px solid #e5e7eb; /* Light border */
            padding: 5px; /* Slightly more padding */
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; /* Slightly larger */
            border-radius: 6px; /* More rounded */
            transition: background-color 0.2s, border-color 0.2s;
        }
        .task-move-actions button svg { width: 14px; height: 14px; }
        .task-move-actions button:hover { background-color: #e5e7eb; border-color: #d1d5db;}
        .move-btn-todo { color: #ef4444; }
        .move-btn-todo:hover { background-color: #fee2e2; border-color: #fca5a5; }
        .move-btn-inprogress { color: #f59e0b; }
        .move-btn-inprogress:hover { background-color: #fef3c7; border-color: #fcd34d; }
        .move-btn-done { color: #22c55e; }
        .move-btn-done:hover { background-color: #dcfce7; border-color: #86efac; }


        .task-timestamp { font-size: 0.7rem; color: #9ca3af; }

        .task-card.priority-low { border-left-color: #22c55e; }
        .task-card.priority-medium { border-left-color: #f59e0b; }
        .task-card.priority-high { border-left-color: #ef4444; }

        .task-card.blocked { background-color: #fee2e2; border-left-color: #b91c1c !important; border-color: #fecaca; }
        .blocked-icon-wrapper { display: flex; align-items: center; margin-top: 8px; }
        .blocked-icon {
            color: #a8071a; font-weight: bold; cursor: help; font-size: 0.8em; margin-right: 6px;
            padding: 3px 6px; background-color: #ffccc7; border-radius: 4px; display: inline-flex; align-items: center;
        }
        .blocked-icon svg { width: 1em; height: 1em; margin-right: 4px; }
        .block-reason-text { font-size: 0.8em; color: #8c8c8c; font-style: italic; }


        .dragging { opacity: 0.4; border: 2px dashed #1890ff; }
        .drag-over-column .tasks-container { background-color: rgba(230, 247, 255, 0.5) !important; border: 1px dashed #91d5ff; }
        .wip-limit-exceeded .tasks-container { border: 2px dashed #ff4d4f !important; background-color: rgba(255, 241, 240, 0.5) !important; }
        .column-at-wip-limit { border: 2px solid #ff7875; }
        .column-at-wip-limit .column-header .task-count-badge::after {
            content: " (WIP Limit!)"; color: #ff4d4f; font-weight: bold; font-size: 0.8em; margin-left: 5px;
        }

        /* --- Bottom Sheet Styling --- */
        #task-detail-bottom-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
            z-index: 1040;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #task-detail-bottom-sheet-overlay.visible {
            display: block;
            opacity: 1;
        }
        #task-detail-bottom-sheet {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background-color: #fff;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.15);
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 1050;
            padding: 20px;
            padding-bottom: 30px; /* Extra space for close button */
            max-height: 80vh; /* Limit height */
            overflow-y: auto;
            display: none; /* Hidden by default */
        }
        #task-detail-bottom-sheet.visible {
            display: block;
            transform: translateY(0);
        }
        #task-detail-bottom-sheet h3 {
            margin-top: 0; margin-bottom: 15px; font-size: 1.25rem; color: #1890ff;
            border-bottom: 1px solid #f0f0f0; padding-bottom: 10px;
        }
        #task-detail-bottom-sheet .detail-item {
            margin-bottom: 10px; font-size: 0.9rem;
        }
        #task-detail-bottom-sheet .detail-item strong {
            color: #374151; /* Darker gray for labels */
            margin-right: 5px;
        }
        #task-detail-bottom-sheet .detail-item span,
        #task-detail-bottom-sheet .detail-item p {
            color: #4b5563;
            white-space: pre-wrap; /* For description */
            word-break: break-word;
        }
        #task-detail-bottom-sheet .bs-tags-container {
            display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px;
        }
        #task-detail-bottom-sheet .bs-tag {
             background-color: #e0e7ff; color: #4338ca; padding: 2px 8px;
            border-radius: 4px; font-size: 0.75rem; font-weight: 500;
        }
        #close-bottom-sheet-btn {
            display: block;
            width: calc(100% - 40px); /* Account for padding */
            margin: 20px auto 0 auto; /* Centered with top margin */
            padding: 12px;
            background-color: #6b7280; /* Gray */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #close-bottom-sheet-btn:hover {
            background-color: #4b5563;
        }


        /* Modal Styling (common for Edit, Add Task, Archived Modals) */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff; margin: auto; padding: 30px; border: none; border-radius: 8px;
            width: 90%; max-width: 600px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            animation: modalFadeIn 0.3s ease-out;
        }
        #archived-tasks-modal .modal-content { max-width: 700px; }
        #archived-tasks-list { max-height: 60vh; overflow-y: auto; }
        #archived-tasks-list p { margin-top: 10px; text-align: center; color: #595959; }
        @keyframes modalFadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content h3 {
            margin-top: 0; color: #1890ff; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; font-weight: 600;
        }
        .modal-content label { display: block; margin-top: 15px; margin-bottom: 8px; font-weight: 500; color: #595959; }
        .modal-content input[type="text"],
        .modal-content input[type="date"],
        .modal-content textarea,
        .modal-content select {
            width: 100%; box-sizing: border-box; padding: 12px; margin-bottom: 15px;
            border: 1px solid #d9d9d9; border-radius: 6px; font-size: 1rem;
        }
        .modal-content input[type="text"]:focus,
        .modal-content input[type="date"]:focus,
        .modal-content textarea:focus,
        .modal-content select:focus {
            border-color: #1890ff; box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2); outline: none;
        }
        .modal-content input[type="checkbox"] {
            margin-right: 8px; vertical-align: middle; width: auto; height: 1.1em; accent-color: #1890ff;
        }
        .modal-content .block-reason-container { margin-top: 10px; }
        .modal-content textarea { min-height: 90px; resize: vertical; }
        .modal-buttons { margin-top: 25px; text-align: right; }
        .modal-buttons button {
            padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 1rem;
            border: none; margin-left: 12px; font-weight: 500;
            transition: background-color 0.3s, transform 0.1s;
        }
        .modal-buttons .save-btn { background-color: #1890ff; color: white; }
        .modal-buttons .save-btn:hover { background-color: #40a9ff; }
        .modal-buttons .cancel-btn { background-color: #f0f0f0; color: #595959; border: 1px solid #d9d9d9;}
        .modal-buttons .cancel-btn:hover { background-color: #e0e0e0; }
        .modal-buttons button:active { transform: scale(0.98); }
        .close-modal-btn {
            color: #aaa; float: right; font-size: 32px; font-weight: bold; line-height: 1;
        }
        .close-modal-btn:hover, .close-modal-btn:focus { color: #595959; text-decoration: none; cursor: pointer; }

        @media (max-width: 767px) {
            #kanban-mobile-tabs { display: flex; }
            .kanban-board { display: block; }
            .kanban-column {
                width: 100%; margin-bottom: 0; display: none;
                background-color: #fff; padding: 10px;
            }
            .kanban-column.active-mobile-column { display: flex; }
            .kanban-column .column-header { display: none; }
            .tasks-container.empty { background-color: transparent; border-width: 1px; }
            .fab-add-task { bottom: 20px; right: 20px; width: 56px; height: 56px; font-size: 24px; line-height: 56px; }
            .actions-bar-container { justify-content: space-between; }
            #task-detail-bottom-sheet { max-height: 90vh; /* Allow more height on mobile */ }
        }
        @media (min-width: 768px) and (max-width: 1250px) {
            .kanban-board { justify-content: flex-start; gap: 10px; }
            .kanban-column { width: calc(50% - 10px); margin-bottom: 20px; }
        }
        @media (max-width: 991px) {
             .filter-bar .actions { grid-column: 1 / -1; justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header id="app-main-header">
            <h1>Ghi ch√∫ Kanban</h1>
        </header>

        <div class="actions-bar-container">
            <button id="view-archived-btn"><span class="icon">üóÑÔ∏è</span> Xem L∆∞u Tr·ªØ</button>
            <button id="toggle-filter-bar-btn"><span class="icon">‚ò∞</span> <span id="toggle-filter-text">Hi·ªán B·ªô L·ªçc</span></button>
        </div>

        <div class="filter-bar" id="filter-bar">
            <div class="form-group"> <label for="search-term-input">T√¨m theo ti√™u ƒë·ªÅ:</label> <input type="text" id="search-term-input" placeholder="Nh·∫≠p t·ª´ kh√≥a..."> </div>
            <div class="form-group"> <label for="filter-priority">L·ªçc theo ∆∞u ti√™n:</label> <select id="filter-priority"> <option value="">T·∫•t c·∫£ ∆∞u ti√™n</option> <option value="high">Cao</option> <option value="medium">Trung b√¨nh</option> <option value="low">Th·∫•p</option> </select> </div>
            <div class="form-group"> <label for="filter-assignee">L·ªçc theo ng∆∞·ªùi th·ª±c hi·ªán:</label> <select id="filter-assignee"> <option value="">T·∫•t c·∫£ ng∆∞·ªùi th·ª±c hi·ªán</option> </select> </div>
            <div class="form-group"> <label for="filter-tag">L·ªçc theo th·∫ª:</label> <select id="filter-tag"> <option value="">T·∫•t c·∫£ th·∫ª</option> </select> </div>
            <div class="form-group"> <label for="filter-blocked">L·ªçc theo tr·∫°ng th√°i ch·∫∑n:</label> <select id="filter-blocked"> <option value="">T·∫•t c·∫£</option> <option value="yes">B·ªã ch·∫∑n</option> <option value="no">Kh√¥ng b·ªã ch·∫∑n</option> </select> </div>
            <div class="form-group"> <label for="filter-due-date">L·ªçc theo ng√†y ƒë·∫øn h·∫°n:</label> <select id="filter-due-date"> <option value="">T·∫•t c·∫£ ng√†y</option> <option value="overdue">Qu√° h·∫°n</option> <option value="today">H√¥m nay</option> <option value="next7days">Trong 7 ng√†y t·ªõi</option> <option value="noduedate">Kh√¥ng c√≥ ng√†y ƒë·∫øn h·∫°n</option> </select> </div>
            <div class="actions"> <button id="apply-filters-btn">√Åp d·ª•ng l·ªçc</button> <button id="clear-filters-btn" class="clear-filter-btn">X√≥a b·ªô l·ªçc</button> </div>
        </div>

        <div id="kanban-mobile-tabs">
            <button class="mobile-tab-button active-tab" id="tab-todo" data-status="todo">
                <span class="icon">üìù</span>C·∫ßn l√†m
            </button>
            <button class="mobile-tab-button" id="tab-inprogress" data-status="inprogress">
                <span class="icon">‚öôÔ∏è</span>ƒêang l√†m
            </button>
            <button class="mobile-tab-button" id="tab-done" data-status="done">
                <span class="icon">‚úîÔ∏è</span>Ho√†n th√†nh
            </button>
        </div>

        <button id="fab-add-task" class="fab-add-task" title="Th√™m c√¥ng vi·ªác m·ªõi">+</button>

        <div class="kanban-board">
            <div class="kanban-column" id="todo" data-status="todo" data-wip-limit="-1">
                <div class="column-header">
                    <span class="title-group">
                        <svg class="column-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 3.75h7.5M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                        <h2>C·∫ßn l√†m</h2>
                    </span>
                    <span class="task-count-badge" id="todo-count">0</span>
                </div>
                <div class="tasks-container"></div>
            </div>
            <div class="kanban-column" id="inprogress" data-status="inprogress" data-wip-limit="3">
                 <div class="column-header">
                    <span class="title-group">
                        <svg class="column-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                        <h2>ƒêang l√†m</h2>
                    </span>
                    <span class="task-count-badge" id="inprogress-count">0</span>
                </div>
                <div class="tasks-container"></div>
            </div>
            <div class="kanban-column" id="done" data-status="done" data-wip-limit="-1">
                 <div class="column-header">
                    <span class="title-group">
                        <svg class="column-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <h2>Ho√†n th√†nh</h2>
                    </span>
                    <span class="task-count-badge" id="done-count">0</span>
                </div>
                <div class="tasks-container"></div>
            </div>
        </div>
    </div>

    <div id="add-task-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="close-add-task-modal-btn">&times;</span>
            <h3>Th√™m c√¥ng vi·ªác m·ªõi</h3>
            <label for="add-modal-task-title">Ti√™u ƒë·ªÅ:</label>
            <input type="text" id="add-modal-task-title" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ...">
            <label for="add-modal-task-desc">M√¥ t·∫£:</label>
            <textarea id="add-modal-task-desc" placeholder="M√¥ t·∫£ chi ti·∫øt (t√πy ch·ªçn)..."></textarea>
            <label for="add-modal-task-status">Tr·∫°ng th√°i:</label>
            <select id="add-modal-task-status">
                <option value="todo">C·∫ßn l√†m</option>
                <option value="inprogress">ƒêang l√†m</option>
                <option value="done">Ho√†n th√†nh</option>
            </select>
            <label for="add-modal-task-priority">ƒê·ªô ∆∞u ti√™n:</label>
            <select id="add-modal-task-priority">
                <option value="medium">Trung b√¨nh</option>
                <option value="high">Cao</option>
                <option value="low">Th·∫•p</option>
            </select>
            <label for="add-modal-task-due-date">Ng√†y ƒë·∫øn h·∫°n:</label>
            <input type="date" id="add-modal-task-due-date">
            <label for="add-modal-task-assignee">Ng∆∞·ªùi th·ª±c hi·ªán:</label>
            <input type="text" id="add-modal-task-assignee" placeholder="T√™n ng∆∞·ªùi th·ª±c hi·ªán...">
            <label for="add-modal-task-tags">Th·∫ª (c√°ch nhau b·ªüi d·∫•u ph·∫©y):</label>
            <input type="text" id="add-modal-task-tags" placeholder="V√≠ d·ª•: bug, feature, urgent">
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" id="cancel-add-task-btn">H·ªßy</button>
                <button type="button" class="save-btn" id="save-new-task-btn">Th√™m Task</button>
            </div>
        </div>
    </div>

    <div id="edit-task-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="close-edit-modal-btn">&times;</span>
            <h3>Ch·ªânh s·ª≠a c√¥ng vi·ªác</h3>
            <input type="hidden" id="edit-task-id">
            <label for="edit-task-title">Ti√™u ƒë·ªÅ:</label>
            <input type="text" id="edit-task-title">
            <label for="edit-task-description">M√¥ t·∫£:</label>
            <textarea id="edit-task-description"></textarea>
            <label for="edit-task-status">Tr·∫°ng th√°i:</label>
            <select id="edit-task-status">
                <option value="todo">C·∫ßn l√†m</option>
                <option value="inprogress">ƒêang l√†m</option>
                <option value="done">Ho√†n th√†nh</option>
            </select>
            <label for="edit-task-priority">ƒê·ªô ∆∞u ti√™n:</label>
            <select id="edit-task-priority">
                <option value="low">Th·∫•p</option>
                <option value="medium">Trung b√¨nh</option>
                <option value="high">Cao</option>
            </select>
            <label for="edit-task-due-date">Ng√†y ƒë·∫øn h·∫°n:</label>
            <input type="date" id="edit-task-due-date">
            <label for="edit-task-assignee">Ng∆∞·ªùi th·ª±c hi·ªán:</label>
            <input type="text" id="edit-task-assignee" placeholder="T√™n ng∆∞·ªùi th·ª±c hi·ªán...">
            <label for="edit-task-tags">Th·∫ª (c√°ch nhau b·ªüi d·∫•u ph·∫©y):</label>
            <input type="text" id="edit-task-tags" placeholder="V√≠ d·ª•: bug, feature, urgent">
            <div>
                <label for="edit-task-blocked">
                    <input type="checkbox" id="edit-task-blocked"> B·ªã ch·∫∑n?
                </label>
            </div>
            <div class="block-reason-container" id="edit-block-reason-container" style="display: none;">
                <label for="edit-task-block-reason">L√Ω do b·ªã ch·∫∑n:</label>
                <textarea id="edit-task-block-reason"></textarea>
            </div>
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" id="cancel-edit-task-btn">H·ªßy</button>
                <button type="button" class="save-btn" id="save-edit-task-btn">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <div id="archived-tasks-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="close-archived-modal-btn">&times;</span>
            <h3>C√¥ng vi·ªác ƒë√£ l∆∞u tr·ªØ</h3>
            <div id="archived-tasks-list">
                <p>Ch·ª©c nƒÉng xem c√¥ng vi·ªác ƒë√£ l∆∞u tr·ªØ s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn sau.</p>
            </div>
        </div>
    </div>

    <div id="custom-alert-overlay" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <p id="custom-alert-message"></p>
            <button id="custom-alert-ok-btn">OK</button>
        </div>
    </div>

    <div id="task-detail-bottom-sheet-overlay"></div>
    <div id="task-detail-bottom-sheet">
        <h3 id="bs-task-title">Chi ti·∫øt c√¥ng vi·ªác</h3>
        <div id="bs-task-description" class="detail-item"><p></p></div>
        <div id="bs-task-assignee" class="detail-item" style="display: none;"><strong>Ng∆∞·ªùi l√†m:</strong> <span></span></div>
        <div id="bs-task-due-date" class="detail-item" style="display: none;"><strong>H·∫°n:</strong> <span></span></div>
        <div id="bs-task-priority" class="detail-item" style="display: none;"><strong>∆Øu ti√™n:</strong> <span></span></div>
        <div id="bs-task-tags" class="detail-item" style="display: none;"><strong>Th·∫ª:</strong> <span class="bs-tags-container"></span></div>
        <div id="bs-task-blocked-status" class="detail-item" style="display: none;"><strong>Tr·∫°ng th√°i:</strong> <span class="bs-blocked-text" style="color: #b91c1c; font-weight: bold;">B·ªä CH·∫∂N</span></div>
        <div id="bs-task-block-reason" class="detail-item" style="display: none;"><strong>L√Ω do ch·∫∑n:</strong> <p></p></div>
        <div id="bs-task-created-at" class="detail-item" style="display: none;"><strong>Ng√†y t·∫°o:</strong> <span></span></div>
        {/* Action buttons like Edit, Delete can be added here later */}
        <button id="close-bottom-sheet-btn">ƒê√≥ng</button>
    </div>


    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
      import {
          getFirestore, collection, addDoc, query, onSnapshot,
          doc, updateDoc, deleteDoc, serverTimestamp
      } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCWfij5n2cTb1jGkUreaLtwi7IENVxssbc",
        authDomain: "testeng-7782.firebaseapp.com",
        projectId: "testeng-7782",
        storageBucket: "testeng-7782.firebasestorage.app",
        messagingSenderId: "741104739298",
        appId: "1:741104739298:web:fde4d379f83c139c33cfbb"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // DOM Elements
      const kanbanColumns = document.querySelectorAll('.kanban-column');
      const customAlertOverlay = document.getElementById('custom-alert-overlay');
      const customAlertMessage = document.getElementById('custom-alert-message');
      const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
      const toggleFilterBarBtn = document.getElementById('toggle-filter-bar-btn');
      const toggleFilterText = document.getElementById('toggle-filter-text');
      const viewArchivedBtn = document.getElementById('view-archived-btn');
      const filterBar = document.getElementById('filter-bar');
      const searchTermInput = document.getElementById('search-term-input');
      const filterPrioritySelect = document.getElementById('filter-priority');
      const filterAssigneeSelect = document.getElementById('filter-assignee');
      const filterTagSelect = document.getElementById('filter-tag');
      const filterBlockedSelect = document.getElementById('filter-blocked');
      const filterDueDateSelect = document.getElementById('filter-due-date');
      const applyFiltersBtn = document.getElementById('apply-filters-btn');
      const clearFiltersBtn = document.getElementById('clear-filters-btn');
      const kanbanMobileTabs = document.getElementById('kanban-mobile-tabs');
      const mobileTabButtons = document.querySelectorAll('.mobile-tab-button');
      let currentActiveMobileColumnId = 'todo';
      const fabAddTaskBtn = document.getElementById('fab-add-task');
      const addTaskModal = document.getElementById('add-task-modal');
      const closeAddTaskModalBtn = document.getElementById('close-add-task-modal-btn');
      const cancelAddTaskBtn = document.getElementById('cancel-add-task-btn');
      const saveNewTaskBtn = document.getElementById('save-new-task-btn');
      const addModalTaskTitleInput = document.getElementById('add-modal-task-title');
      const addModalTaskDescInput = document.getElementById('add-modal-task-desc');
      const addModalTaskStatusInput = document.getElementById('add-modal-task-status');
      const addModalTaskPriorityInput = document.getElementById('add-modal-task-priority');
      const addModalTaskDueDateInput = document.getElementById('add-modal-task-due-date');
      const addModalTaskAssigneeInput = document.getElementById('add-modal-task-assignee');
      const addModalTaskTagsInput = document.getElementById('add-modal-task-tags');
      const editTaskModal = document.getElementById('edit-task-modal');
      const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
      const cancelEditTaskBtn = document.getElementById('cancel-edit-task-btn');
      const saveEditTaskBtn = document.getElementById('save-edit-task-btn');
      const editTaskIdInput = document.getElementById('edit-task-id');
      const editTaskTitleInput = document.getElementById('edit-task-title');
      const editTaskDescInput = document.getElementById('edit-task-description');
      const editTaskStatusInput = document.getElementById('edit-task-status');
      const editTaskPriorityInput = document.getElementById('edit-task-priority');
      const editTaskDueDateInput = document.getElementById('edit-task-due-date');
      const editTaskAssigneeInput = document.getElementById('edit-task-assignee');
      const editTaskTagsInput = document.getElementById('edit-task-tags');
      const editTaskBlockedCheckbox = document.getElementById('edit-task-blocked');
      const editBlockReasonContainer = document.getElementById('edit-block-reason-container');
      const editTaskBlockReasonInput = document.getElementById('edit-task-block-reason');
      const archivedTasksModal = document.getElementById('archived-tasks-modal');
      const closeArchivedModalBtn = document.getElementById('close-archived-modal-btn');
      const archivedTasksList = document.getElementById('archived-tasks-list');

      // Bottom Sheet DOM Elements
      const bottomSheetOverlay = document.getElementById('task-detail-bottom-sheet-overlay');
      const bottomSheet = document.getElementById('task-detail-bottom-sheet');
      const bsTaskTitle = document.getElementById('bs-task-title');
      const bsTaskDescription = document.getElementById('bs-task-description').querySelector('p');
      const bsTaskAssignee = document.getElementById('bs-task-assignee');
      const bsTaskDueDate = document.getElementById('bs-task-due-date');
      const bsTaskPriority = document.getElementById('bs-task-priority');
      const bsTaskTags = document.getElementById('bs-task-tags');
      const bsTaskTagsContainer = bsTaskTags.querySelector('.bs-tags-container');
      const bsTaskBlockedStatus = document.getElementById('bs-task-blocked-status');
      const bsTaskBlockReason = document.getElementById('bs-task-block-reason').querySelector('p');
      const bsTaskCreatedAt = document.getElementById('bs-task-created-at');
      const closeBottomSheetBtn = document.getElementById('close-bottom-sheet-btn');


      let draggedTask = null;
      let currentEditingTaskId = null;
      const TASKS_COLLECTION = 'tasks_kanban_public_v14_bs'; // Updated collection name
      const priorityMap = { high: 'Cao', medium: 'Trung b√¨nh', low: 'Th·∫•p' };
      let currentTaskCounts = { todo: 0, inprogress: 0, done: 0 };
      let allTasks = [];

      // SVG Icons
      const iconPinOutline = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25L7.5 16.5V3.75m9 0H7.5A2.25 2.25 0 005.25 6v10.5A2.25 2.25 0 007.5 18.75h9A2.25 2.25 0 0018.75 16.5V6A2.25 2.25 0 0016.5 3.75z" /></svg>`;
      const iconPinSolid = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M6.32 2.577a49.255 49.255 0 0111.36 0c1.497.174 2.57 1.46 2.57 2.93V21a.75.75 0 01-1.085.67L12 18.089l-7.165 3.583A.75.75 0 013.75 21V5.507c0-1.47 1.073-2.756 2.57-2.93z" clip-rule="evenodd" /></svg>`;
      const iconMoreVertical = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" /></svg>`;
      const iconArrowLeft = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>`;
      const iconArrowRight = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>`;
      const iconCheck = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;

      function showAlert(message) { customAlertMessage.textContent = message; customAlertOverlay.style.display = 'flex'; }
      customAlertOkBtn.addEventListener('click', () => { customAlertOverlay.style.display = 'none'; });

      function formatDateForDisplay(dateString) {
          if (!dateString) return 'N/A';
          const date = new Date(dateString);
          const userTimezoneOffset = date.getTimezoneOffset() * 60000;
          const correctedDate = new Date(date.getTime() + userTimezoneOffset);
          return correctedDate.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }
      function getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function openAddTaskModal() {
        addModalTaskTitleInput.value = ''; addModalTaskDescInput.value = '';
        addModalTaskStatusInput.value = currentActiveMobileColumnId || 'todo';
        addModalTaskPriorityInput.value = 'medium';
        addModalTaskDueDateInput.value = ''; addModalTaskAssigneeInput.value = ''; addModalTaskTagsInput.value = '';
        addTaskModal.style.display = 'flex';
      }
      function closeAddTaskModal() { addTaskModal.style.display = 'none'; }
      fabAddTaskBtn.addEventListener('click', openAddTaskModal);
      closeAddTaskModalBtn.addEventListener('click', closeAddTaskModal);
      cancelAddTaskBtn.addEventListener('click', closeAddTaskModal);
      saveNewTaskBtn.addEventListener('click', () => {
          const title = addModalTaskTitleInput.value; const description = addModalTaskDescInput.value;
          const status = addModalTaskStatusInput.value; const priority = addModalTaskPriorityInput.value;
          const dueDate = addModalTaskDueDateInput.value; const assignee = addModalTaskAssigneeInput.value.trim();
          const tags = addModalTaskTagsInput.value.trim();
          addTaskToFirestore(title, description, status, priority, dueDate, assignee, tags);
      });

      editTaskBlockedCheckbox.addEventListener('change', function() {
          editBlockReasonContainer.style.display = this.checked ? 'block' : 'none';
          if (!this.checked) editTaskBlockReasonInput.value = '';
      });
      function openEditModal(task) {
          currentEditingTaskId = task.id; editTaskIdInput.value = task.id;
          editTaskTitleInput.value = task.title; editTaskDescInput.value = task.description || '';
          editTaskStatusInput.value = task.status; editTaskPriorityInput.value = task.priority || 'medium';
          editTaskDueDateInput.value = task.dueDate || ''; editTaskAssigneeInput.value = task.assignee || '';
          editTaskTagsInput.value = Array.isArray(task.tags) ? task.tags.join(', ') : '';
          editTaskBlockedCheckbox.checked = task.isBlocked || false;
          editTaskBlockReasonInput.value = task.blockReason || '';
          editBlockReasonContainer.style.display = editTaskBlockedCheckbox.checked ? 'block' : 'none';
          editTaskModal.style.display = 'flex';
      }
      function closeEditModal() { editTaskModal.style.display = 'none'; currentEditingTaskId = null; }
      closeEditModalBtn.onclick = closeEditModal;
      cancelEditTaskBtn.onclick = closeEditModal;
      saveEditTaskBtn.addEventListener('click', async () => {
          if (!currentEditingTaskId) return;
          const updatedTitle = editTaskTitleInput.value.trim(); const updatedDescription = editTaskDescInput.value.trim();
          const updatedStatus = editTaskStatusInput.value; const updatedPriority = editTaskPriorityInput.value;
          const updatedDueDate = editTaskDueDateInput.value; const updatedAssignee = editTaskAssigneeInput.value.trim();
          const updatedTagsString = editTaskTagsInput.value.trim();
          const updatedTags = updatedTagsString ? updatedTagsString.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
          const isBlocked = editTaskBlockedCheckbox.checked;
          const blockReason = isBlocked ? editTaskBlockReasonInput.value.trim() : "";

          if (!updatedTitle) { showAlert("Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!"); return; }
          if (isBlocked && !blockReason) { showAlert("Vui l√≤ng nh·∫≠p l√Ω do b·ªã ch·∫∑n!"); return; }

          try {
              const taskRef = doc(db, TASKS_COLLECTION, currentEditingTaskId);
              await updateDoc(taskRef, {
                  title: updatedTitle, description: updatedDescription, status: updatedStatus,
                  priority: updatedPriority, dueDate: updatedDueDate, assignee: updatedAssignee,
                  tags: updatedTags, isBlocked: isBlocked, blockReason: blockReason,
                  updatedAt: serverTimestamp()
              });
              showAlert("C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng!"); closeEditModal();
          } catch (error) { console.error("Error updating task:", error); showAlert("L·ªói c·∫≠p nh·∫≠t task: " + error.message); }
      });

      function openArchivedTasksModal() {
          archivedTasksList.innerHTML = '<p>Ch·ª©c nƒÉng xem c√¥ng vi·ªác ƒë√£ l∆∞u tr·ªØ s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn ·ªü c√°c phi√™n b·∫£n sau.</p>';
          archivedTasksModal.style.display = 'flex';
      }
      function closeArchivedTasksModal() { archivedTasksModal.style.display = 'none'; }
      viewArchivedBtn.addEventListener('click', openArchivedTasksModal);
      closeArchivedModalBtn.addEventListener('click', closeArchivedTasksModal);

      // --- Bottom Sheet Logic ---
      function openBottomSheet(taskData) {
        bsTaskTitle.textContent = taskData.title;
        bsTaskDescription.textContent = taskData.description || '(Kh√¥ng c√≥ m√¥ t·∫£)';

        if (taskData.assignee) {
            bsTaskAssignee.style.display = 'block';
            bsTaskAssignee.querySelector('span').textContent = taskData.assignee;
        } else {
            bsTaskAssignee.style.display = 'none';
        }

        if (taskData.dueDate) {
            bsTaskDueDate.style.display = 'block';
            const dueDateSpan = bsTaskDueDate.querySelector('span');
            dueDateSpan.textContent = formatDateForDisplay(taskData.dueDate);
            dueDateSpan.className = 'task-due-date-display'; // Reset classes
            const today = getTodayDateString();
            if (taskData.dueDate < today) dueDateSpan.classList.add('due-overdue');
            else {
                const todayDate = new Date(today); const dueDateObj = new Date(taskData.dueDate);
                const diffTime = dueDateObj - todayDate; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays <= 1 && diffDays >=0 ) dueDateSpan.classList.add('due-soon');
            }
        } else {
            bsTaskDueDate.style.display = 'none';
        }

        bsTaskPriority.style.display = 'block';
        bsTaskPriority.querySelector('span').textContent = priorityMap[taskData.priority || 'medium'];

        if (taskData.tags && taskData.tags.length > 0) {
            bsTaskTags.style.display = 'block';
            bsTaskTagsContainer.innerHTML = '';
            taskData.tags.forEach(tagText => {
                const tagSpan = document.createElement('span');
                tagSpan.classList.add('bs-tag');
                tagSpan.textContent = tagText;
                bsTaskTagsContainer.appendChild(tagSpan);
            });
        } else {
            bsTaskTags.style.display = 'none';
        }

        if (taskData.isBlocked) {
            bsTaskBlockedStatus.style.display = 'block';
            if (taskData.blockReason) {
                bsTaskBlockReason.parentElement.style.display = 'block';
                bsTaskBlockReason.textContent = taskData.blockReason;
            } else {
                bsTaskBlockReason.parentElement.style.display = 'none';
            }
        } else {
            bsTaskBlockedStatus.style.display = 'none';
            bsTaskBlockReason.parentElement.style.display = 'none';
        }

        if (taskData.createdAt && taskData.createdAt.toDate) {
            bsTaskCreatedAt.style.display = 'block';
            bsTaskCreatedAt.querySelector('span').textContent = formatDateForDisplay(taskData.createdAt.toDate().toISOString().split('T')[0]) + " " + taskData.createdAt.toDate().toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
        } else {
            bsTaskCreatedAt.style.display = 'none';
        }

        bottomSheet.classList.add('visible');
        bottomSheetOverlay.classList.add('visible');
      }

      function closeBottomSheet() {
        bottomSheet.classList.remove('visible');
        bottomSheetOverlay.classList.remove('visible');
      }
      closeBottomSheetBtn.addEventListener('click', closeBottomSheet);
      bottomSheetOverlay.addEventListener('click', closeBottomSheet);


      window.onclick = function(event) {
          if (event.target == editTaskModal) closeEditModal();
          if (event.target == addTaskModal) closeAddTaskModal();
          if (event.target == archivedTasksModal) closeArchivedTasksModal();
          if (event.target == customAlertOverlay) customAlertOverlay.style.display = 'none';
          // Do not close bottom sheet on overlay click here, handled by its own listener for better control
      };

      function updateColumnUI() {
          kanbanColumns.forEach(column => {
              const status = column.dataset.status;
              const countBadge = column.querySelector('.task-count-badge');
              const wipLimit = parseInt(column.dataset.wipLimit, 10);
              const currentCount = currentTaskCounts[status] || 0;
              if (countBadge) countBadge.textContent = currentCount;
              column.classList.remove('wip-limit-exceeded', 'column-at-wip-limit');
              if (wipLimit !== -1 && currentCount >= wipLimit) {
                  column.classList.add('column-at-wip-limit');
              }
          });
      }

      async function addTaskToFirestore(title, description, status, priority, dueDate, assignee, tagsString) {
        if (!title.trim()) { showAlert("Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!"); return; }
        const columnElement = document.getElementById(status);
        if (!columnElement) { showAlert(`L·ªói: Kh√¥ng t√¨m th·∫•y c·ªôt cho tr·∫°ng th√°i "${status}".`); return; }
        const wipLimit = parseInt(columnElement.dataset.wipLimit, 10);
        if (wipLimit !== -1 && currentTaskCounts[status] >= wipLimit) {
            const h2Element = columnElement.querySelector('.column-header h2');
            let columnName = status;
            if (h2Element && h2Element.offsetParent !== null) {
                columnName = h2Element.textContent.trim();
            } else {
                const tabButton = document.getElementById(`tab-${status}`);
                if (tabButton) {
                    columnName = Array.from(tabButton.childNodes).filter(node => node.nodeType === Node.TEXT_NODE).map(node => node.textContent.trim()).join('') || status;
                }
            }
            showAlert(`C·ªôt "${columnName}" ƒë√£ ƒë·∫°t gi·ªõi h·∫°n WIP (${wipLimit}). Kh√¥ng th·ªÉ th√™m task m·ªõi.`); return;
        }
        const tagsArray = tagsString ? tagsString.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
        try {
            await addDoc(collection(db, TASKS_COLLECTION), {
                title, description, status, priority, dueDate, assignee,
                tags: tagsArray, isBlocked: false, blockReason: "", createdAt: serverTimestamp(), isPinned: false
            });
            showAlert("Th√™m c√¥ng vi·ªác m·ªõi th√†nh c√¥ng!"); closeAddTaskModal();
        } catch (e) { console.error("Error adding task: ", e); showAlert("L·ªói th√™m task: " + e.message); }
      }

      function createTaskCard(taskData) {
          const taskCard = document.createElement('div');
          taskCard.classList.add('task-card');
          taskCard.setAttribute('draggable', 'true');
          taskCard.dataset.id = taskData.id;
          taskCard.dataset.status = taskData.status;
          taskCard.dataset.priority = taskData.priority || 'medium';
          taskCard.dataset.isPinned = taskData.isPinned ? 'true' : 'false';

          taskCard.classList.remove('priority-high', 'priority-medium', 'priority-low');
          taskCard.classList.add(`priority-${taskData.priority || 'medium'}`);

          if (taskData.isPinned) taskCard.classList.add('task-pinned');
          if (taskData.isBlocked) taskCard.classList.add('blocked');


          // Card Header
          const cardHeader = document.createElement('div');
          cardHeader.classList.add('task-card-header');
          const titleText = document.createElement('p');
          titleText.classList.add('task-card-title-text');
          titleText.textContent = taskData.title;
          // titleText.onclick = () => openEditModal(taskData); // Edit will be in bottom sheet
          cardHeader.appendChild(titleText);

          const cardActions = document.createElement('div');
          cardActions.classList.add('task-card-actions');
          const pinButton = document.createElement('button');
          pinButton.classList.add('pin-btn');
          pinButton.innerHTML = taskData.isPinned ? iconPinSolid : iconPinOutline;
          pinButton.title = taskData.isPinned ? "B·ªè ghim" : "Ghim";
          if(taskData.isPinned) pinButton.classList.add('pinned');
          pinButton.onclick = (e) => { e.stopPropagation(); togglePinTask(taskData); };
          cardActions.appendChild(pinButton);

          const moreButton = document.createElement('button');
          moreButton.innerHTML = iconMoreVertical;
          moreButton.title = "Xem chi ti·∫øt & H√†nh ƒë·ªông";
          moreButton.onclick = (e) => { e.stopPropagation(); openBottomSheet(taskData); };
          cardActions.appendChild(moreButton);
          cardHeader.appendChild(cardActions);
          taskCard.appendChild(cardHeader);

          // Minimal Indicators (e.g., due date if soon/overdue, priority badge)
          const minimalIndicators = document.createElement('div');
          minimalIndicators.classList.add('task-card-minimal-indicators');

          if (taskData.dueDate) {
              const today = getTodayDateString();
              const dueDate = taskData.dueDate;
              let dueDateIndicatorText = '';
              let dueDateClass = '';

              if (dueDate < today) {
                  dueDateIndicatorText = `H·∫°n: ${formatDateForDisplay(dueDate)} (Qu√° h·∫°n)`;
                  dueDateClass = 'due-overdue';
              } else {
                  const todayDate = new Date(today); const dueDateObj = new Date(dueDate);
                  const diffTime = dueDateObj - todayDate; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                  if (diffDays === 0) {
                      dueDateIndicatorText = "H·∫°n: H√¥m nay";
                      dueDateClass = 'due-soon';
                  } else if (diffDays === 1) {
                      dueDateIndicatorText = "H·∫°n: Ng√†y mai";
                      dueDateClass = 'due-soon';
                  }
                  // Optionally, show normal due date if not soon/overdue
                  // else { dueDateIndicatorText = `H·∫°n: ${formatDateForDisplay(dueDate)}`; }
              }
              if (dueDateIndicatorText) {
                  const dueDateIndicator = document.createElement('span');
                  dueDateIndicator.classList.add('task-due-date-indicator', dueDateClass);
                  dueDateIndicator.textContent = dueDateIndicatorText;
                  minimalIndicators.appendChild(dueDateIndicator);
              }
          }

          const priorityBadge = document.createElement('span');
          priorityBadge.classList.add('priority-indicator-badge', `prio-${taskData.priority || 'medium'}`);
          priorityBadge.textContent = priorityMap[taskData.priority || 'medium'];
          minimalIndicators.appendChild(priorityBadge);

          if (minimalIndicators.hasChildNodes()) {
              taskCard.appendChild(minimalIndicators);
          }


          // Card Footer
          const cardFooter = document.createElement('div');
          cardFooter.classList.add('task-card-footer');
          const moveActions = document.createElement('div');
          moveActions.classList.add('task-move-actions');

          if (taskData.status !== 'todo') {
              const moveToTodoBtn = document.createElement('button');
              moveToTodoBtn.innerHTML = iconArrowLeft; moveToTodoBtn.title = "Chuy·ªÉn sang C·∫ßn l√†m";
              moveToTodoBtn.classList.add('move-btn-todo');
              moveToTodoBtn.onclick = (e) => { e.stopPropagation(); updateTaskStatusInFirestore(taskData.id, 'todo', taskData.status); };
              moveActions.appendChild(moveToTodoBtn);
          }
          // Always show inprogress button unless it's already inprogress
          if (taskData.status !== 'inprogress') {
              const moveToInProgressBtn = document.createElement('button');
              moveToInProgressBtn.innerHTML = (taskData.status === 'todo') ? iconArrowRight : iconArrowLeft; // Right if from todo, Left if from done
              moveToInProgressBtn.title = "Chuy·ªÉn sang ƒêang l√†m";
              moveToInProgressBtn.classList.add('move-btn-inprogress');
              moveToInProgressBtn.onclick = (e) => { e.stopPropagation(); updateTaskStatusInFirestore(taskData.id, 'inprogress', taskData.status); };
              moveActions.appendChild(moveToInProgressBtn);
          }

          if (taskData.status !== 'done') {
              const moveToDoneBtn = document.createElement('button');
              moveToDoneBtn.innerHTML = iconCheck; moveToDoneBtn.title = "Ho√†n th√†nh";
              moveToDoneBtn.classList.add('move-btn-done');
              moveToDoneBtn.onclick = (e) => { e.stopPropagation(); updateTaskStatusInFirestore(taskData.id, 'done', taskData.status); };
              moveActions.appendChild(moveToDoneBtn);
          }
          cardFooter.appendChild(moveActions);

          const timestamp = document.createElement('span');
          timestamp.classList.add('task-timestamp');
          timestamp.textContent = taskData.createdAt && taskData.createdAt.toDate ?
            formatDateForDisplay(taskData.createdAt.toDate().toISOString().split('T')[0])
            // + " " + taskData.createdAt.toDate().toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) // Optionally add time
            : 'N/A';
          cardFooter.appendChild(timestamp);
          taskCard.appendChild(cardFooter);

          taskCard.addEventListener('dragstart', handleDragStart);
          taskCard.addEventListener('dragend', handleDragEnd);
          return taskCard;
      }
      async function togglePinTask(taskData) {
        if (!taskData || !taskData.id) return;
        const newPinnedState = !taskData.isPinned;
        try {
            const taskRef = doc(db, TASKS_COLLECTION, taskData.id);
            await updateDoc(taskRef, { isPinned: newPinnedState });
        } catch (error) {
            console.error("Error toggling pin state:", error);
            showAlert("L·ªói khi ghim/b·ªè ghim c√¥ng vi·ªác.");
        }
      }

      async function updateTaskStatusInFirestore(taskId, newStatus, oldStatus) {
          const columnElement = document.getElementById(newStatus);
          if (!columnElement) { showAlert(`L·ªói: Kh√¥ng t√¨m th·∫•y c·ªôt cho tr·∫°ng th√°i "${newStatus}".`); return false; }
          const wipLimit = parseInt(columnElement.dataset.wipLimit, 10);
          if (wipLimit !== -1 && currentTaskCounts[newStatus] >= wipLimit && newStatus !== oldStatus) {
             const h2Element = columnElement.querySelector('.column-header h2');
             let columnName = newStatus;
             if (h2Element && h2Element.offsetParent !== null) {
                 columnName = h2Element.textContent.trim();
             } else {
                 const tabButton = document.getElementById(`tab-${newStatus}`);
                 if (tabButton) {
                     columnName = Array.from(tabButton.childNodes).filter(node => node.nodeType === Node.TEXT_NODE).map(node => node.textContent.trim()).join('') || newStatus;
                 }
             }
             showAlert(`C·ªôt "${columnName}" ƒë√£ ƒë·∫°t gi·ªõi h·∫°n WIP (${wipLimit}). Kh√¥ng th·ªÉ chuy·ªÉn task.`); return false;
          }
          try {
              const taskRef = doc(db, TASKS_COLLECTION, taskId);
              const taskToUpdate = allTasks.find(t => t.id === taskId);
              await updateDoc(taskRef, { status: newStatus, updatedAt: serverTimestamp(), isPinned: (newStatus === 'done' ? false : (taskToUpdate?.isPinned || false)) });
              if (newStatus === 'done' && oldStatus !== 'done') {
                  console.log("Task moved to done!");
              }
              return true;
          } catch (error) { console.error("Error updating task status:", error); showAlert("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i task: " + error.message); return false; }
      }
      async function deleteTask(taskId) {
          try { await deleteDoc(doc(db, TASKS_COLLECTION, taskId)); showAlert("X√≥a c√¥ng vi·ªác th√†nh c√¥ng!"); }
          catch (error) { console.error("Error deleting task:", error); showAlert("L·ªói x√≥a task: " + error.message); }
      }

      function handleDragStart(event) {
          draggedTask = event.target.closest('.task-card');
          if (!draggedTask) return;
          event.dataTransfer.setData('text/plain', draggedTask.dataset.id);
          setTimeout(() => { if(draggedTask) draggedTask.classList.add('dragging'); }, 0);
      }
      function handleDragEnd(event) {
          if (draggedTask) draggedTask.classList.remove('dragging'); draggedTask = null;
          kanbanColumns.forEach(col => {
            const tasksContainer = col.querySelector('.tasks-container');
            if(tasksContainer) tasksContainer.classList.remove('drag-over-column', 'wip-limit-exceeded');
          });
      }
      kanbanColumns.forEach(column => {
          const tasksContainer = column.querySelector('.tasks-container');
          tasksContainer.addEventListener('dragover', (event) => {
              event.preventDefault();
              if (!draggedTask) return;
              tasksContainer.classList.add('drag-over-column');
              const targetColumnEl = column;
              const targetStatus = targetColumnEl.dataset.status;
              const wipLimit = parseInt(targetColumnEl.dataset.wipLimit, 10);
              const currentCountInTarget = currentTaskCounts[targetStatus] || 0;
              if (draggedTask.dataset.status !== targetStatus && wipLimit !== -1 && currentCountInTarget >= wipLimit) {
                  event.dataTransfer.dropEffect = 'none';
                  tasksContainer.classList.add('wip-limit-exceeded');
              } else {
                  event.dataTransfer.dropEffect = 'move';
                  tasksContainer.classList.remove('wip-limit-exceeded');
              }
          });
          tasksContainer.addEventListener('dragleave', (event) => {
              tasksContainer.classList.remove('drag-over-column', 'wip-limit-exceeded');
          });
          tasksContainer.addEventListener('drop', async (event) => {
              event.preventDefault();
              if (!draggedTask) return;
              tasksContainer.classList.remove('drag-over-column', 'wip-limit-exceeded');
              const targetColumnEl = column;
              const taskId = draggedTask.dataset.id;
              const oldStatus = draggedTask.dataset.status;
              const newStatus = targetColumnEl.dataset.status;
              if (oldStatus !== newStatus) {
                  await updateTaskStatusInFirestore(taskId, newStatus, oldStatus);
              }
          });
      });

      toggleFilterBarBtn.addEventListener('click', () => {
          filterBar.classList.toggle('filter-bar-visible');
          const buttonTextSpan = toggleFilterBarBtn.querySelector('#toggle-filter-text');
          if (filterBar.classList.contains('filter-bar-visible')) {
              if(buttonTextSpan) buttonTextSpan.textContent = '·∫®n B·ªô L·ªçc';
          } else {
              if(buttonTextSpan) buttonTextSpan.textContent = 'Hi·ªán B·ªô L·ªçc';
          }
      });
      function populateFilterOptions() {
          const assignees = new Set(); const tags = new Set();
          allTasks.forEach(task => {
              if (task.assignee) assignees.add(task.assignee);
              if (task.tags && Array.isArray(task.tags)) task.tags.forEach(tag => tags.add(tag));
          });
          filterAssigneeSelect.innerHTML = '<option value="">T·∫•t c·∫£ ng∆∞·ªùi th·ª±c hi·ªán</option>';
          Array.from(assignees).sort().forEach(assignee => {
              const option = document.createElement('option'); option.value = assignee; option.textContent = assignee;
              filterAssigneeSelect.appendChild(option);
          });
          filterTagSelect.innerHTML = '<option value="">T·∫•t c·∫£ th·∫ª</option>';
          Array.from(tags).sort().forEach(tag => {
              const option = document.createElement('option'); option.value = tag; option.textContent = tag;
              filterTagSelect.appendChild(option);
          });
      }
      function applyAllFilters() {
          const searchTerm = searchTermInput.value.toLowerCase(); const selectedPriority = filterPrioritySelect.value;
          const selectedAssignee = filterAssigneeSelect.value; const selectedTag = filterTagSelect.value;
          const selectedBlocked = filterBlockedSelect.value; const selectedDueDate = filterDueDateSelect.value;
          const filteredTasks = allTasks.filter(task => {
              if (searchTerm && !task.title.toLowerCase().includes(searchTerm)) return false;
              if (selectedPriority && task.priority !== selectedPriority) return false;
              if (selectedAssignee && task.assignee !== selectedAssignee) return false;
              if (selectedTag && (!task.tags || !task.tags.includes(selectedTag))) return false;
              if (selectedBlocked) {
                  if (selectedBlocked === "yes" && !task.isBlocked) return false;
                  if (selectedBlocked === "no" && task.isBlocked) return false;
              }
              if (selectedDueDate) {
                  const today = new Date(getTodayDateString()); today.setHours(0,0,0,0);
                  if (selectedDueDate === "noduedate") { if (task.dueDate) return false; }
                  else if (!task.dueDate) { return false; }
                  else {
                      const taskDueDate = new Date(task.dueDate); taskDueDate.setHours(0,0,0,0);
                      if (selectedDueDate === "overdue") { if (taskDueDate >= today) return false; }
                      else if (selectedDueDate === "today") { if (taskDueDate.getTime() !== today.getTime()) return false; }
                      else if (selectedDueDate === "next7days") {
                          const nextWeek = new Date(today); nextWeek.setDate(today.getDate() + 7);
                          if (taskDueDate < today || taskDueDate > nextWeek) return false;
                      }
                  }
              }
              return true;
          });
          renderFilteredTasks(filteredTasks);
      }
      function renderFilteredTasks(tasksToRender) {
          kanbanColumns.forEach(column => {
              const container = column.querySelector('.tasks-container');
              container.innerHTML = ''; container.classList.remove('empty');
          });
          currentTaskCounts = { todo: 0, inprogress: 0, done: 0 };
          tasksToRender.forEach((taskData) => {
              if (!taskData.status || !currentTaskCounts.hasOwnProperty(taskData.status)) taskData.status = 'todo';
              currentTaskCounts[taskData.status]++;
              const taskCardElement = createTaskCard(taskData);
              const columnContainer = document.getElementById(taskData.status)?.querySelector('.tasks-container');
              if (columnContainer) columnContainer.appendChild(taskCardElement);
              else console.warn(`Column container for status "${taskData.status}" not found.`);
          });

          const emptyIconSvg = `<svg class="empty-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>`;
          let hasActiveFilters = searchTermInput.value || filterPrioritySelect.value || filterAssigneeSelect.value || filterTagSelect.value || filterBlockedSelect.value || filterDueDateSelect.value;
          kanbanColumns.forEach(column => {
              const status = column.dataset.status;
              const container = column.querySelector('.tasks-container');
              if (currentTaskCounts[status] === 0) {
                  let message;
                  const columnTitleElement = column.querySelector('.column-header h2');
                  const tabButton = document.getElementById(`tab-${status}`);
                  let columnDisplayName = status;
                  if (columnTitleElement && columnTitleElement.offsetParent !== null) {
                      columnDisplayName = columnTitleElement.textContent.trim();
                  } else if (tabButton) {
                     columnDisplayName = Array.from(tabButton.childNodes).filter(node => node.nodeType === Node.TEXT_NODE).map(node => node.textContent.trim()).join('') || status;
                  }
                  if (hasActiveFilters) message = `Kh√¥ng c√≥ c√¥ng vi·ªác n√†o kh·ªõp b·ªô l·ªçc.`;
                  else message = `Ch∆∞a c√≥ c√¥ng vi·ªác n√†o. Nh·∫•n "+" ƒë·ªÉ th√™m.`;
                  container.innerHTML = `${emptyIconSvg}<p>${message}</p>`;
                  container.classList.add('empty');
              }
          });
          updateColumnUI(); handleMobileLayout();
      }
      applyFiltersBtn.addEventListener('click', applyAllFilters);
      clearFiltersBtn.addEventListener('click', () => {
          searchTermInput.value = ''; filterPrioritySelect.value = ''; filterAssigneeSelect.value = '';
          filterTagSelect.value = ''; filterBlockedSelect.value = ''; filterDueDateSelect.value = '';
          applyAllFilters();
      });

      function setActiveMobileColumn(status) {
          currentActiveMobileColumnId = status;
          mobileTabButtons.forEach(btn => {
              btn.classList.remove('active-tab');
              if (btn.dataset.status === status) btn.classList.add('active-tab');
          });
          kanbanColumns.forEach(col => {
              if (col.id === status) { col.classList.add('active-mobile-column'); col.style.display = 'flex'; }
              else { col.classList.remove('active-mobile-column'); col.style.display = 'none'; }
          });
      }
      mobileTabButtons.forEach(button => {
          button.addEventListener('click', () => { setActiveMobileColumn(button.dataset.status); });
      });
      function handleMobileLayout() {
          if (window.innerWidth < 768) {
              kanbanMobileTabs.style.display = 'flex';
              setActiveMobileColumn(currentActiveMobileColumnId);
          } else {
              kanbanMobileTabs.style.display = 'none';
              kanbanColumns.forEach(col => {
                  col.style.display = 'flex'; col.classList.remove('active-mobile-column');
              });
          }
      }
      window.addEventListener('resize', handleMobileLayout);

      const q = query(collection(db, TASKS_COLLECTION));
      onSnapshot(q, (querySnapshot) => {
          allTasks = [];
          querySnapshot.forEach((docSnap) => { allTasks.push({ ...docSnap.data(), id: docSnap.id }); });
          allTasks.sort((a, b) => {
            if (a.isPinned && !b.isPinned) return -1; if (!a.isPinned && b.isPinned) return 1;
            if (a.createdAt && b.createdAt) return b.createdAt.toMillis() - a.createdAt.toMillis();
            else if (a.createdAt) return -1; else if (b.createdAt) return 1; return 0;
          });
          populateFilterOptions(); applyAllFilters();
      }, (error) => {
          console.error("Error fetching tasks with onSnapshot: ", error);
          showAlert("L·ªói t·∫£i danh s√°ch c√¥ng vi·ªác: " + error.message);
      });
      handleMobileLayout();
    </script>
</body>
</html>
